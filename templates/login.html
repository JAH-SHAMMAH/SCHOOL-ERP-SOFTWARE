<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>School ERP Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-light: #818cf8;
        --secondary: #8b5cf6;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --sidebar-bg: #0f172a;
        --sidebar-hover: #1e293b;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
        color: var(--text-primary);
        line-height: 1.6;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(99, 102, 241, 0.2),
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(139, 92, 246, 0.2),
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 20%,
            rgba(236, 72, 153, 0.15),
            transparent 40%
          );
        pointer-events: none;
        z-index: 0;
        animation: gradientShift 15s ease infinite;
      }

      @keyframes gradientShift {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        background: var(--sidebar-bg);
        color: #fff;
        overflow-y: auto;
        padding: 0;
        box-shadow: var(--shadow-xl), 4px 0 24px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.5);
        border-radius: 3px;
        transition: background 0.3s;
      }

      .sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.7);
      }

      .sidebar-header {
        padding: 32px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.15) 0%,
          rgba(139, 92, 246, 0.15) 100%
        );
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .sidebar-header:hover {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.2) 0%,
          rgba(139, 92, 246, 0.2) 100%
        );
      }

      .sidebar-header h4 {
        font-size: 1.5rem;
        font-weight: 800;
        color: #fff;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 12px;
        letter-spacing: -0.025em;
      }

      .sidebar-header h4 i {
        font-size: 1.75rem;
        color: var(--primary-light);
        filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.4));
      }

      .sidebar-header .subtitle {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 600;
      }

      .menu-section {
        padding: 24px 16px 8px;
      }

      .menu-section h5 {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        margin-bottom: 12px;
        padding-left: 12px;
        font-weight: 700;
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        color: #cbd5e1;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9375rem;
        position: relative;
        overflow: hidden;
      }

      .menu-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        transform: scaleY(0);
        transition: transform 0.3s ease;
      }

      .menu-item:hover {
        background: var(--sidebar-hover);
        color: #fff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
      }

      .menu-item:hover::before {
        transform: scaleY(1);
      }

      .menu-item.active {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: #fff;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        transform: translateX(4px);
      }

      .menu-item.active::before {
        transform: scaleY(1);
      }

      .menu-item i {
        width: 20px;
        margin-right: 12px;
        font-size: 1rem;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .menu-item:hover i,
      .menu-item.active i {
        transform: scale(1.1);
      }

      /* Content Area */
      .content {
        margin-left: 280px;
        padding: 32px;
        min-height: 100vh;
        position: relative;
        z-index: 1;
      }

      .top-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 28px 36px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-lg), 0 0 40px rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.8);
        position: relative;
        overflow: hidden;
      }

      .top-bar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--secondary) 50%,
          var(--primary) 100%
        );
        background-size: 200% 100%;
        animation: shimmer 3s linear infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .top-bar h2 {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
        letter-spacing: -0.025em;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 8px 16px 8px 8px;
        background: rgba(99, 102, 241, 0.05);
        border-radius: 50px;
        transition: all 0.3s ease;
      }

      .user-info:hover {
        background: rgba(99, 102, 241, 0.1);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
      }

      .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        position: relative;
      }

      .user-avatar::after {
        content: "";
        position: absolute;
        inset: -3px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        opacity: 0.3;
        filter: blur(8px);
        z-index: -1;
      }

      .user-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .user-name {
        font-weight: 600;
        font-size: 0.9375rem;
        color: var(--text-primary);
        line-height: 1.2;
      }

      .user-role {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* Content Card */
      .content-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 36px;
        box-shadow: var(--shadow-lg);
        animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--border-color);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Buttons */
      .btn {
        font-weight: 600;
        border-radius: 12px;
        padding: 12px 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        font-size: 0.9375rem;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          var(--secondary) 100%
        );
      }

      .btn-primary:active {
        transform: translateY(0);
      }

      .btn-secondary {
        background: #64748b;
        color: #fff;
      }

      .btn-secondary:hover {
        background: #475569;
        transform: translateY(-2px);
        box-shadow: 0 4px 14px rgba(100, 116, 139, 0.3);
      }

      .btn-link {
        color: var(--primary);
        font-weight: 600;
        text-decoration: none;
        padding: 8px 0;
        transition: all 0.2s ease;
      }

      .btn-link:hover {
        color: var(--primary-dark);
        text-decoration: underline;
      }

      /* Form Controls */
      .form-control,
      .form-select {
        border-radius: 12px;
        border: 2px solid var(--border-color);
        padding: 14px 18px;
        transition: all 0.3s ease;
        font-size: 0.9375rem;
        background: #fff;
        font-weight: 500;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        outline: none;
        background: #fff;
      }

      .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 0.875rem;
      }

      /* Tables */
      .table {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        background: #fff;
      }

      .table thead {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
      }

      .table thead th {
        padding: 18px 24px;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.8px;
        border: none;
      }

      .table tbody td {
        padding: 18px 24px;
        vertical-align: middle;
        border-color: var(--border-color);
        font-size: 0.9375rem;
        font-weight: 500;
      }

      .table tbody tr {
        transition: all 0.2s ease;
        background: white;
      }

      .table tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: white;
        padding: 32px;
        border-radius: 20px;
        box-shadow: var(--shadow-md);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .stat-card::after {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(99, 102, 241, 0.05) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
      }

      .stat-card:hover::before {
        opacity: 1;
      }

      .stat-card:hover::after {
        opacity: 1;
      }

      .stat-card .icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        margin-bottom: 20px;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 1;
      }

      .stat-card:hover .icon {
        transform: scale(1.1) rotate(5deg);
      }

      .stat-card h3 {
        font-size: 2.25rem;
        font-weight: 800;
        margin: 0;
        color: var(--text-primary);
        letter-spacing: -0.025em;
        position: relative;
        z-index: 1;
      }

      .stat-card p {
        color: var(--text-secondary);
        margin: 8px 0 0;
        font-size: 0.9375rem;
        font-weight: 600;
        position: relative;
        z-index: 1;
      }

      /* Login Styles */
      .text-primary {
        color: #667eea !important;
        text-decoration: none;
        font-weight: 600;
      }

      .text-primary:hover {
        text-decoration: underline;
      }
      .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        position: relative;
        z-index: 1;
      }

      .login-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 48px;
        max-width: 480px;
        width: 100%;
        box-shadow: var(--shadow-xl), 0 0 60px rgba(99, 102, 241, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.8);
        animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .login-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .login-card h2 {
        text-align: center;
        margin-bottom: 36px;
        font-weight: 800;
        font-size: 2rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .login-card h2 i {
        font-size: 2.25rem;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.3));
      }

      /* OTP Inputs */
      .otp-inputs {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin: 28px 0;
      }

      .otp-input {
        width: 60px;
        height: 60px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        border: 2px solid var(--border-color);
        border-radius: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #fff;
      }

      .otp-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        outline: none;
        transform: scale(1.08);
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.02) 0%,
          rgba(139, 92, 246, 0.02) 100%
        );
      }

      .timer {
        text-align: center;
        font-size: 0.9375rem;
        color: var(--text-secondary);
        margin: 16px 0;
        font-weight: 600;
      }

      .resend-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-weight: 700;
        cursor: pointer;
        padding: 0;
        transition: all 0.2s ease;
      }

      .resend-btn:hover:not(:disabled) {
        color: var(--primary-dark);
        text-decoration: underline;
        transform: scale(1.05);
      }

      .resend-btn:disabled {
        color: #94a3b8;
        cursor: not-allowed;
      }

      /* Alerts */
      .alert {
        border-radius: 14px;
        border: none;
        padding: 18px 24px;
        box-shadow: var(--shadow-sm);
        font-weight: 500;
        font-size: 0.9375rem;
        border-left: 4px solid;
      }

      .alert i {
        margin-right: 10px;
        font-size: 1.125rem;
      }

      .alert-success {
        background: #d1fae5;
        color: #065f46;
        border-left-color: var(--success);
      }

      .alert-danger {
        background: #fee2e2;
        color: #991b1b;
        border-left-color: var(--danger);
      }

      .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border-left-color: var(--info);
      }

      .alert-warning {
        background: #fef3c7;
        color: #92400e;
        border-left-color: var(--warning);
      }

      /* Badges */
      .badge {
        border-radius: 10px;
        padding: 6px 14px;
        font-weight: 600;
        font-size: 0.8125rem;
        letter-spacing: 0.025em;
      }

      .bg-success {
        background: var(--success) !important;
      }

      .bg-danger {
        background: var(--danger) !important;
      }

      .bg-warning {
        background: var(--warning) !important;
        color: #fff !important;
      }

      .bg-primary {
        background: var(--primary) !important;
      }

      .bg-secondary {
        background: #6b7280 !important;
      }

      /* Cards */
      .card {
        border: none;
        border-radius: 18px;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        overflow: hidden;
      }

      .card:hover {
        transform: translateY(-6px);
        box-shadow: var(--shadow-lg);
      }

      .card-body {
        padding: 28px;
      }

      .card-title {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
        font-size: 1.125rem;
      }

      /* Loading Spinner */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .text-muted {
        color: var(--text-secondary) !important;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .content {
          margin-left: 0;
          padding: 20px;
        }

        .top-bar {
          padding: 20px 24px;
          border-radius: 16px;
        }

        .top-bar h2 {
          font-size: 1.5rem;
        }

        .content-card {
          padding: 24px;
          border-radius: 16px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .otp-inputs {
          gap: 8px;
        }

        .otp-input {
          width: 48px;
          height: 48px;
          font-size: 1.25rem;
        }

        .login-card {
          padding: 32px 24px;
          border-radius: 20px;
        }

        .login-card h2 {
          font-size: 1.75rem;
        }
      }

      /* Custom scrollbar for content area */
      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.3);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="login-container" id="loginContainer">
      <div id="loginScreen" class="login-card">
        <h2><i class="fas fa-graduation-cap"></i> School ERP Login</h2>
        <div id="loginAlert" class="alert alert-danger d-none"></div>
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email Address</label>
            <input
              type="email"
              class="form-control"
              id="loginEmail"
              required
              placeholder="Enter your email"
            />
          </div>
          <div class="mb-4">
            <label class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="loginPassword"
              required
              placeholder="Enter your password"
            />
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <span id="loginBtnText">Continue</span>
            <span id="loginLoading" class="loading d-none"></span>
          </button>
        </form>
        <div class="text-center mt-3">
          <small class="text-muted">
            Don't have an account?
            <a href="login" id="signupLink" class="text-primary">Sign up</a>
          </small>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted">
            example: <strong>admin@fairviewschoolng.com</strong> /
            <strong>admin123</strong>
          </small>
        </div>
      </div>

      <div id="otpScreen" class="login-card d-none">
        <h2><i class="fas fa-envelope"></i> Verify OTP</h2>
        <p class="text-center text-muted">
          Enter the 6-digit code sent to <strong id="otpEmail"></strong>
        </p>
        <div id="otpAlert" class="alert alert-danger d-none"></div>
        <div class="otp-inputs">
          <input type="text" maxlength="1" class="otp-input" id="otp1" />
          <input type="text" maxlength="1" class="otp-input" id="otp2" />
          <input type="text" maxlength="1" class="otp-input" id="otp3" />
          <input type="text" maxlength="1" class="otp-input" id="otp4" />
          <input type="text" maxlength="1" class="otp-input" id="otp5" />
          <input type="text" maxlength="1" class="otp-input" id="otp6" />
        </div>
        <div class="timer" id="otpTimer"></div>
        <button id="verifyOtpBtn" class="btn btn-primary w-100 mt-3">
          <span id="verifyBtnText">Verify OTP</span>
          <span id="verifyLoading" class="loading d-none"></span>
        </button>
        <div class="text-center mt-3">
          <small class="text-muted">
            Didn't receive code?
            <button class="resend-btn" id="resendBtn" disabled>
              Resend OTP
            </button>
          </small>
        </div>
        <button class="btn btn-link w-100 mt-2" id="backBtn">
          Back to Login
        </button>
      </div>
    </div>

    <div id="dashboardScreen" class="d-none">
      <div class="sidebar">
        <div class="sidebar-header">
          <h4><i class="fas fa-graduation-cap"></i> Fairview ERP</h4>
          <div class="subtitle">Management System</div>
        </div>

        <!-- Dynamic menu container - JavaScript will populate this based on user role -->
        <div id="sidebarMenu">
          <!-- Default menu items (will be replaced by JavaScript based on role) -->
          <div class="menu-section">
            <h5>Main</h5>
            <a class="menu-item active" data-endpoint="dashboard">
              <i class="fas fa-home"></i> Dashboard
            </a>
          </div>
          <div class="menu-section">
            <h5>Authentication</h5>
            <a class="menu-item" data-endpoint="register">
              <i class="fas fa-user-plus"></i> Register User
            </a>
            <a class="menu-item" data-endpoint="profile">
              <i class="fas fa-user"></i> My Profile
            </a>
            <a class="menu-item" data-endpoint="logout">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </div>
          <div class="menu-section">
            <h5>Students</h5>
            <a class="menu-item" data-endpoint="students">
              <i class="fas fa-users"></i> All Students
            </a>
            <a class="menu-item" data-endpoint="add-student">
              <i class="fas fa-user-plus"></i> Add Student
            </a>
          </div>
          <div class="menu-section">
            <h5>Teachers</h5>
            <a class="menu-item" data-endpoint="teachers">
              <i class="fas fa-chalkboard-teacher"></i> All Teachers
            </a>
            <a class="menu-item" data-endpoint="add-teacher">
              <i class="fas fa-user-plus"></i> Add Teacher
            </a>
          </div>
          <div class="menu-section">
            <h5>Academic</h5>
            <a class="menu-item" data-endpoint="classes">
              <i class="fas fa-door-open"></i> Classes
            </a>
            <a class="menu-item" data-endpoint="subjects">
              <i class="fas fa-book"></i> Subjects
            </a>
            <a class="menu-item" data-endpoint="exams">
              <i class="fas fa-file-alt"></i> Exams
            </a>
          </div>
          <div class="menu-section">
            <h5>Attendance</h5>
            <a class="menu-item" data-endpoint="mark-attendance">
              <i class="fas fa-calendar-check"></i> Mark Attendance
            </a>
            <a class="menu-item" data-endpoint="view-attendance">
              <i class="fas fa-eye"></i> View Attendance
            </a>
          </div>
          <div class="menu-section">
            <h5>Finance</h5>
            <a class="menu-item" data-endpoint="fee-structures">
              <i class="fas fa-money-bill-wave"></i> Fee Structures
            </a>
            <a class="menu-item" data-endpoint="fee-payments">
              <i class="fas fa-credit-card"></i> Fee Payments
            </a>
            <a class="menu-item" data-endpoint="pending-fees">
              <i class="fas fa-exclamation-circle"></i> Pending Fees
            </a>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="top-bar">
          <div style="display: flex; align-items: center; gap: 12px">
            <button
              data-toggle="sidebar"
              id="sidebarToggle"
              class="btn btn-sm btn-outline-light"
              title="Toggle sidebar"
            >
              <i class="fas fa-bars"></i>
            </button>
            <h2 id="pageTitle">Dashboard</h2>
          </div>
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
              <div class="user-name" id="userName">Admin User</div>
              <small class="user-role" id="userRole">Administrator</small>
            </div>
          </div>
        </div>
        <div id="contentArea" class="content-card"></div>
      </div>
    </div>

    <!-- Customer Care widget -->
    <style>
      .cc-widget {
        position: fixed;
        right: 20px;
        bottom: 24px;
        z-index: 9999;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
      }
      .cc-button {
        background: #6803db;
        color: #530ed3;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(37, 211, 102, 0.18);
        cursor: pointer;
        border: none;
      }
      .cc-panel {
        position: fixed;
        right: 92px;
        bottom: 24px;
        width: 320px;
        max-width: calc(100vw - 120px);
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 20px 40px rgba(2, 6, 23, 0.12);
        display: none;
        flex-direction: column;
        gap: 8px;
      }
      .cc-panel.visible {
        display: flex;
      }
      .cc-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .cc-header h4 {
        margin: 0;
        font-size: 1rem;
        color: #0f172a;
      }
      .cc-body {
        font-size: 0.9rem;
        color: #374151;
      }
      .cc-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .cc-actions .cc-link {
        text-decoration: none;
        background: #25d366;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 700;
      }
      .cc-close {
        background: transparent;
        border: none;
        font-size: 18px;
        color: #6b7280;
        cursor: pointer;
      }
      @media (max-width: 520px) {
        .cc-panel {
          right: 12px;
          left: 12px;
          width: auto;
        }
      }
    </style>

    <div class="cc-widget" aria-hidden="false">
      <button id="ccToggleBtn" class="cc-button" aria-label="Customer care">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            d="M21 15a2 2 0 0 1-2 2h-1l-3 3v-3H8a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v9z"
            stroke="white"
            stroke-width="1.4"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <div
        id="ccPanel"
        class="cc-panel"
        role="dialog"
        aria-label="Customer care panel"
      >
        <div class="cc-header">
          <h4>Customer Care</h4>
          <button id="ccCloseBtn" class="cc-close" aria-label="Close">×</button>
        </div>
        <div class="cc-body">
          <p>
            Need help with Fairview School ERP? Chat with our support on
            WhatsApp and we'll respond shortly.
          </p>
        </div>
        <div class="cc-actions">
          <a id="ccWhatsAppBtn" class="cc-link" href="#">WhatsApp Us</a>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const CC_PHONE_RAW = "08036745916";
        function toInternational(s) {
          s = (s || "").trim();
          if (!s) return s;
          if (s.startsWith("+")) return s.slice(1);
          if (s.startsWith("0")) return "234" + s.slice(1);
          return s;
        }
        const CC_INT = toInternational(CC_PHONE_RAW);

        const toggleBtn = document.getElementById("ccToggleBtn");
        const panel = document.getElementById("ccPanel");
        const closeBtn = document.getElementById("ccCloseBtn");
        const waBtn = document.getElementById("ccWhatsAppBtn");

        function toggle() {
          panel.classList.toggle("visible");
        }
        function openWhatsApp(pretext) {
          const txt = encodeURIComponent(pretext || "Hello, I need EXTRCARE!");
          const url = `https://wa.me/${CC_INT}?text=${txt}`;
          window.open(url, "_blank");
        }

        if (toggleBtn) toggleBtn.addEventListener("click", () => toggle());
        if (closeBtn)
          closeBtn.addEventListener("click", () =>
            panel.classList.remove("visible")
          );
        if (waBtn)
          waBtn.addEventListener("click", (e) => {
            e.preventDefault();
            openWhatsApp();
          });
      })();
    </script>

    <!-- Modals for child progress and admin actions -->
    <!-- Child Progress Modal -->
    <div
      class="modal fade"
      id="childProgressModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Child Progress</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="childProgressAlert"></div>
            <div class="mb-3">
              <label class="form-label">Select Child</label>
              <select id="childSelect" class="form-select">
                <option value="">Loading...</option>
              </select>
            </div>
            <div id="childProgressContent">
              Select a child to load progress.
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin: Add Fee Structure Modal -->
    <div class="modal fade" id="addFeeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Fee Structure</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="addFeeAlert"></div>
            <form id="addFeeForm">
              <div class="mb-3">
                <label class="form-label">Academic Year</label>
                <input name="academic_year" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Class ID</label>
                <input name="class_id" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Amount (NGN)</label>
                <input
                  name="amount"
                  type="number"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  name="description"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
              <div class="text-end">
                <button class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin: Add Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add School Event</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="addEventAlert"></div>
            <form id="addEventForm">
              <div class="mb-3">
                <label class="form-label">Title</label>
                <input name="title" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Date</label>
                <input name="date" type="date" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Details</label>
                <textarea
                  name="details"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>
              <div class="text-end">
                <button class="btn btn-primary">Create Event</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Cleaned role-based script
      // Use the current page origin so API calls match where the page is served from
      const API_BASE = window.location?.origin || "http://localhost:8000";
      const appState = { token: null, user: null, email: null, password: null };

      function showScreen(screen) {
        const loginContainer = document.getElementById("loginContainer");
        const loginScreen = document.getElementById("loginScreen");
        const otpScreen = document.getElementById("otpScreen");
        const dashboardScreen = document.getElementById("dashboardScreen");

        if (screen === "dashboardScreen") {
          if (loginContainer) loginContainer.remove();
          dashboardScreen.classList.remove("d-none");
          dashboardScreen.style.display = "block";
        } else if (screen === "otpScreen") {
          loginScreen.classList.add("d-none");
          otpScreen.classList.remove("d-none");
        } else {
          loginScreen.classList.remove("d-none");
          otpScreen.classList.add("d-none");
        }
        window.scrollTo(0, 0);
      }

      function showAlert(id, msg, type = "danger") {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = msg;
        el.className = `alert alert-${type}`;
        el.classList.remove("d-none");
        setTimeout(() => el.classList.add("d-none"), 5000);
      }

      async function apiRequest(endpoint, options = {}) {
        const headers = {
          ...(options.headers || {}),
        };
        // Only set JSON content type when not sending FormData
        const isFormData =
          options && options.body && options.body instanceof FormData;
        if (!isFormData) headers["Content-Type"] = "application/json";
        // If caller supplied an Authorization header (e.g. adminOverrideToken), honor it.
        // Otherwise fall back to the logged-in user's token stored in appState.
        if (!headers.Authorization && appState.token)
          headers.Authorization = `Bearer ${appState.token}`;
        const res = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          // Ensure we throw a readable string message (detail may be object/array)
          const detail = data.detail || data.message || "Request failed";
          const msg =
            typeof detail === "string" ? detail : JSON.stringify(detail);
          throw new Error(msg);
        }
        return data;
      }

      function resolvePhotoUrl(raw) {
        if (!raw) return null;
        if (/^(data:|https?:\/\/)/i.test(raw)) return raw;
        if (raw.startsWith("/")) return `${API_BASE}${raw}`;
        return `${API_BASE}/${raw}`;
      }

      function updateUserInfo() {
        if (!appState.user) return;
        document.getElementById("userName").textContent =
          appState.user.full_name || appState.user.name || "User";
        document.getElementById("userRole").textContent =
          appState.user.role || "";
        const avatarDiv = document.getElementById("userAvatar");
        const photo = resolvePhotoUrl(appState.user.photo_url);
        if (photo) {
          const cacheBusted = `${photo}${
            photo.includes("?") ? "&" : "?"
          }v=${Date.now()}`;
          avatarDiv.innerHTML = `<img src="${cacheBusted}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>`;
        } else {
          avatarDiv.textContent = (
            appState.user.full_name ||
            appState.user.name ||
            "?"
          )
            .charAt(0)
            .toUpperCase();
        }
      }

      // Avatar/Profile helpers
      function openProfileModal() {
        const mEl = document.getElementById("profileModal");
        if (!mEl) return;
        loadProfileData();
        const m = new bootstrap.Modal(mEl);
        m.show();
      }

      async function loadProfileData() {
        try {
          const me = await apiRequest("/auth/me");
          appState.user.photo_url =
            me.photo_url || appState.user.photo_url || null;
          const wrap = document.getElementById("profileAvatarWrapper");
          if (wrap) {
            const resolved = resolvePhotoUrl(appState.user.photo_url);
            if (resolved) {
              wrap.innerHTML = `<img src="${resolved}" alt="avatar" class="rounded-circle" style="width:120px;height:120px;object-fit:cover;"/>`;
            } else {
              const letter = (
                appState.user.full_name ||
                appState.user.name ||
                "?"
              )
                .charAt(0)
                .toUpperCase();
              wrap.innerHTML = `<div class="d-flex align-items-center justify-content-center rounded-circle bg-primary text-white fw-bold" style="width:120px;height:120px;font-size:48px;">${letter}</div>`;
            }
          }
          const pageAv = document.getElementById("profilePageAvatar");
          if (pageAv) {
            const resolvedProfile = resolvePhotoUrl(appState.user.photo_url);
            if (resolvedProfile) {
              pageAv.innerHTML = `<img src="${resolvedProfile}" alt="avatar" style="width:100%;height:100%;object-fit:cover;"/>`;
            } else {
              const letter2 = (
                appState.user.full_name ||
                appState.user.name ||
                "?"
              )
                .charAt(0)
                .toUpperCase();
              pageAv.textContent = letter2;
            }
          }
          updateUserInfo();
        } catch (e) {
          console.error("Profile load failed", e);
        }
      }

      async function uploadAvatar() {
        const input =
          document.getElementById("avatarFileInput") ||
          document.getElementById("profileAvatarFileInput");
        const statusEl =
          document.getElementById("avatarStatus") ||
          document.getElementById("profileAvatarStatus");
        statusEl.textContent = "";
        if (!input.files || !input.files[0]) {
          statusEl.textContent = "Select an image.";
          return;
        }
        try {
          const fd = new FormData();
          fd.append("file", input.files[0]);
          const res = await fetch(`${API_BASE}/auth/avatar`, {
            method: "POST",
            headers: appState.token
              ? { Authorization: `Bearer ${appState.token}` }
              : {},
            body: fd,
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok)
            throw new Error(data.detail || data.message || "Upload failed");
          appState.user.photo_url = data.photo_url;
          statusEl.textContent = "Uploaded ✓";
          loadProfileData();
        } catch (e) {
          statusEl.textContent = e.message;
        }
      }

      async function removeAvatar() {
        const statusEl =
          document.getElementById("avatarStatus") ||
          document.getElementById("profileAvatarStatus");
        statusEl.textContent = "";
        try {
          const res = await fetch(`${API_BASE}/auth/avatar`, {
            method: "DELETE",
            headers: appState.token
              ? { Authorization: `Bearer ${appState.token}` }
              : {},
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok)
            throw new Error(data.detail || data.message || "Remove failed");
          appState.user.photo_url = null;
          statusEl.textContent = "Removed.";
          loadProfileData();
        } catch (e) {
          statusEl.textContent = e.message;
        }
      }

      function triggerProfileAvatarUpload() {
        const inp = document.getElementById("profileAvatarFileInput");
        if (inp) inp.click();
        inp?.addEventListener("change", () => uploadAvatar());
      }

      // OTP helpers
      const otpInputs = Array.from(document.querySelectorAll(".otp-input"));
      let otpTimer = null;
      function startOtpTimer(seconds = 300) {
        clearInterval(otpTimer);
        let rem = seconds;
        document.getElementById("resendBtn").disabled = true;
        otpTimer = setInterval(() => {
          rem--;
          const m = Math.floor(rem / 60);
          const s = String(rem % 60).padStart(2, "0");
          document.getElementById(
            "otpTimer"
          ).textContent = `Code expires in ${m}:${s}`;
          if (rem <= 0) {
            clearInterval(otpTimer);
            document.getElementById("otpTimer").textContent = "Code expired";
            document.getElementById("resendBtn").disabled = false;
          }
        }, 1000);
      }
      otpInputs.forEach((input, i) => {
        input.addEventListener("input", (e) => {
          if (e.target.value.length === 1 && otpInputs[i + 1])
            otpInputs[i + 1].focus();
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !e.target.value && otpInputs[i - 1])
            otpInputs[i - 1].focus();
        });
        input.addEventListener("paste", (e) => {
          e.preventDefault();
          const t = (e.clipboardData.getData("text") || "").slice(0, 6);
          t.split("").forEach((ch, idx) => {
            if (otpInputs[idx]) otpInputs[idx].value = ch;
          });
          if (t.length === 6 && otpInputs[5]) otpInputs[5].focus();
        });
      });

      // Login -> request OTP
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("loginEmail").value.trim();
          const password = document.getElementById("loginPassword").value;
          document.getElementById("loginBtnText").classList.add("d-none");
          document.getElementById("loginLoading").classList.remove("d-none");
          try {
            const resp = await fetch(`${API_BASE}/request-otp`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password, purpose: "login" }),
            });
            if (!resp.ok)
              throw new Error(
                (await resp.json()).detail || "Failed to request OTP"
              );
            appState.email = email;
            appState.password = password;
            document.getElementById("otpEmail").textContent = email;
            showScreen("otpScreen");
            startOtpTimer();
            otpInputs[0].focus();
          } catch (err) {
            showAlert("loginAlert", err.message || String(err));
          } finally {
            document.getElementById("loginBtnText").classList.remove("d-none");
            document.getElementById("loginLoading").classList.add("d-none");
          }
        });

      // Verify OTP -> exchange for token
      async function completeLoginWithOtp() {
        const otp = otpInputs.map((i) => i.value).join("");
        if (otp.length !== 6) {
          showAlert("otpAlert", "Enter all 6 digits");
          return;
        }
        document.getElementById("verifyBtnText").classList.add("d-none");
        document.getElementById("verifyLoading").classList.remove("d-none");
        try {
          const v = await fetch(`${API_BASE}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: appState.email, otp }),
          });
          if (!v.ok) throw new Error((await v.json()).detail || "Invalid OTP");
          const form = new URLSearchParams();
          form.append("username", appState.email);
          form.append("password", appState.password);
          const tokenRes = await fetch(`${API_BASE}/token`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: form,
          });
          if (!tokenRes.ok)
            throw new Error((await tokenRes.json()).detail || "Login failed");
          const tokenData = await tokenRes.json();
          appState.token = tokenData.access_token;
          appState.user = tokenData.user_info || tokenData.user || {};
          clearInterval(otpTimer);
          showScreen("dashboardScreen");
          updateUserInfo();
          loadDashboardByRole(appState.user);
          localStorage.setItem("currentUser", JSON.stringify(appState.user));
          try {
            localStorage.setItem("currentToken", appState.token);
          } catch (e) {}
        } catch (err) {
          showAlert("otpAlert", err.message || String(err));
        } finally {
          document.getElementById("verifyBtnText").classList.remove("d-none");
          document.getElementById("verifyLoading").classList.add("d-none");
        }
      }
      document
        .getElementById("verifyOtpBtn")
        .addEventListener("click", completeLoginWithOtp);

      document
        .getElementById("resendBtn")
        .addEventListener("click", async () => {
          try {
            const resp = await fetch(`${API_BASE}/request-otp`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: appState.email,
                password: appState.password,
                purpose: "login",
              }),
            });
            if (!resp.ok) throw new Error("Failed to resend OTP");
            otpInputs.forEach((i) => (i.value = ""));
            otpInputs[0].focus();
            startOtpTimer();
            showAlert("otpAlert", "OTP resent", "success");
          } catch (err) {
            showAlert("otpAlert", err.message || String(err));
          }
        });
      document.getElementById("backBtn").addEventListener("click", () => {
        clearInterval(otpTimer);
        otpInputs.forEach((i) => (i.value = ""));
        showScreen("loginScreen");
      });

      // ---------------------------
      // Role-based loader (parents, students, staff, admin)
      // ---------------------------
      function loadDashboardByRole(user) {
        if (!user) return renderError("No user data");
        const role = (user.role || "").toLowerCase();
        const menu = document.getElementById("sidebarMenu");
        const content = document.getElementById("contentArea"); // clear any existing content to prevent residual text or stray renderings
        content.innerHTML = "";
        menu.innerHTML = "";
        const sections = [];
        sections.push({
          title: "Main",
          items: [
            { endpoint: "dashboard", icon: "fa-home", label: "Dashboard" },
            { endpoint: "store", icon: "fa-store", label: "Store" },
            {
              endpoint: "news-feed",
              icon: "fa-newspaper",
              label: "News Feed & Birthdays",
            },
          ],
        });
        if (role === "admin") {
          sections.push({
            title: "Communications",
            items: [
              { endpoint: "admin-sms", icon: "fa-sms", label: "SMS/WhatsApp" },
              {
                endpoint: "admin-mailbox",
                icon: "fa-envelope",
                label: "Mailbox",
              },
              {
                endpoint: "admin-news-feed",
                icon: "fa-newspaper",
                label: "News Feed",
              },
              {
                endpoint: "pending-messages",
                icon: "fa-clock",
                label: "Pending Messages",
              },
            ],
          });
          // AI Advisor dedicated menu section
          sections.push({
            title: "AI Advisor",
            items: [
              {
                endpoint: "admin-ai-advisor",
                icon: "fa-robot",
                label: "AI Advisor",
              },
            ],
          });
          sections.push({
            title: "Academic Management",
            items: [
              {
                endpoint: "admin-e-classroom",
                icon: "fa-video",
                label: "E-Classroom",
              },
              {
                endpoint: "admin-lesson-planner",
                icon: "fa-calendar-day",
                label: "Lesson Planner",
              },
              {
                endpoint: "admin-assignments",
                icon: "fa-tasks",
                label: "Assignments",
              },
              { endpoint: "admin-cbт", icon: "fa-laptop", label: "CBT" },
              {
                endpoint: "admin-classes",
                icon: "fa-door-open",
                label: "Classes",
              },
              {
                endpoint: "admin-subjects",
                icon: "fa-book",
                label: "Subjects",
              },
              { endpoint: "admin-exams", icon: "fa-file-alt", label: "Exams" },
            ],
          });
          sections.push({
            title: "HR & Staff",
            items: [
              {
                endpoint: "admin-hr",
                icon: "fa-users-cog",
                label: "HR Management",
              },
              {
                endpoint: "admin-teachers",
                icon: "fa-chalkboard-teacher",
                label: "Teachers",
              },
              {
                endpoint: "admin-parents",
                icon: "fa-user-tie",
                label: "Parents Management",
              },
            ],
          });
          sections.push({
            title: "Students & Welfare",
            items: [
              {
                endpoint: "admin-students",
                icon: "fa-users",
                label: "Students",
              },
              {
                endpoint: "admin-medicals",
                icon: "fa-heart",
                label: "Medical Records",
              },
              {
                endpoint: "admin-talent-pool",
                icon: "fa-star",
                label: "Talent Pool",
              },
              {
                endpoint: "admin-visitor-mgmt",
                icon: "fa-user-check",
                label: "Visitor Management",
              },
            ],
          });
          sections.push({
            title: "Facilities & Resources",
            items: [
              {
                endpoint: "admin-facilities",
                icon: "fa-building",
                label: "Facility Management",
              },
              {
                endpoint: "admin-photo-journals",
                icon: "fa-images",
                label: "Photo Journals",
              },
            ],
          });
          sections.push({
            title: "Operations",
            items: [
              {
                endpoint: "admin-attendance",
                icon: "fa-calendar-check",
                label: "Attendance",
              },
              {
                endpoint: "admin-reports",
                icon: "fa-chart-bar",
                label: "Reports",
              },
              {
                endpoint: "admin-clubs",
                icon: "fa-users-circle",
                label: "Clubs & Societies",
              },
              {
                endpoint: "admin-revenues",
                icon: "fa-money-bill-wave",
                label: "Weekly Revenues",
              },
            ],
          });
          sections.push({
            title: "Finance",
            items: [
              {
                endpoint: "fee-structures",
                icon: "fa-money-bill-wave",
                label: "Fee Structures",
              },
              {
                endpoint: "fee-payments",
                icon: "fa-credit-card",
                label: "Fee Payments",
              },
              {
                endpoint: "pending-fees",
                icon: "fa-exclamation-circle",
                label: "Pending Fees",
              },
              {
                endpoint: "payments",
                icon: "fa-wallet",
                label: "All Payments",
              },
            ],
          });
          sections.push({
            title: "Authentication",
            items: [
              {
                endpoint: "register",
                icon: "fa-user-plus",
                label: "Register User",
              },
              { endpoint: "profile", icon: "fa-user", label: "My Profile" },
              { endpoint: "logout", icon: "fa-sign-out-alt", label: "Logout" },
            ],
          });
          renderAdminDashboard();
        } else if (role === "teacher" || role === "staff") {
          sections.push({
            title: "Academic Management",
            items: [
              {
                endpoint: "teacher-e-classroom",
                icon: "fa-video",
                label: "E-Classroom",
              },
              {
                endpoint: "teacher-lesson-planner",
                icon: "fa-calendar-day",
                label: "Lesson Planner",
              },
              {
                endpoint: "teacher-assignments",
                icon: "fa-tasks",
                label: "Assignments",
              },
              {
                endpoint: "teacher-subjects",
                icon: "fa-book",
                label: "My Subjects",
              },
              { endpoint: "teacher-cbt", icon: "fa-laptop", label: "CBT" },
              { endpoint: "exams", icon: "fa-file-alt", label: "Exams" },
            ],
          });
          sections.push({
            title: "Records & Reports",
            items: [
              {
                endpoint: "teacher-timetable",
                icon: "fa-clock",
                label: "My Timetable",
              },
              {
                endpoint: "teacher-secondary-report",
                icon: "fa-chart-line",
                label: "Secondary School Report",
              },
              {
                endpoint: "teacher-behaviour-tracker",
                icon: "fa-list-check",
                label: "Behaviour Tracker",
              },
              {
                endpoint: "teacher-pastoral",
                icon: "fa-handshake",
                label: "Pastoral Care",
              },
            ],
          });
          sections.push({
            title: "Engagement",
            items: [
              {
                endpoint: "teacher-hrm",
                icon: "fa-users-cog",
                label: "HRM Info",
              },
              {
                endpoint: "teacher-feedback",
                icon: "fa-comments",
                label: "Feedback & Ratings",
              },
            ],
          });
          sections.push({
            title: "Account",
            items: [
              { endpoint: "profile", icon: "fa-user", label: "My Profile" },
              { endpoint: "logout", icon: "fa-sign-out-alt", label: "Logout" },
            ],
          });
          renderStaffDashboard(user);
        } else if (role === "student") {
          sections.push({
            title: "Academic",
            items: [
              {
                endpoint: "student-rate-teacher",
                icon: "fa-star",
                label: "Rate My Teacher",
              },
              {
                endpoint: "student-subjects",
                icon: "fa-book",
                label: "My Subjects",
              },
              {
                endpoint: "student-scores",
                icon: "fa-chart-line",
                label: "My Scores",
              },
              { endpoint: "student-cbt", icon: "fa-laptop", label: "CBT" },
              { endpoint: "exams", icon: "fa-file-alt", label: "My Exams" },
            ],
          });
          sections.push({
            title: "Account",
            items: [
              { endpoint: "profile", icon: "fa-user", label: "My Profile" },
              { endpoint: "logout", icon: "fa-sign-out-alt", label: "Logout" },
            ],
          });
          renderStudentDashboard(user);
        } else if (role === "parent") {
          sections.push({
            title: "Finance & Payments",
            items: [
              {
                endpoint: "parent-wallet",
                icon: "fa-wallet",
                label: "My Wallet",
              },
              {
                endpoint: "parent-fees",
                icon: "fa-receipt",
                label: "School Fees",
              },
              {
                endpoint: "parent-bills",
                icon: "fa-file-invoice",
                label: "Bills & Invoices",
              },
              {
                endpoint: "make-payment",
                icon: "fa-credit-card",
                label: "Make Payment",
              },
              {
                endpoint: "payment-status",
                icon: "fa-check-circle",
                label: "Payment Status",
              },
            ],
          });
          sections.push({
            title: "School Portal",
            items: [
              {
                endpoint: "parent-store",
                icon: "fa-shopping-cart",
                label: "School Store",
              },
              {
                endpoint: "parent-store-appointments",
                icon: "fa-calendar-check",
                label: "Store Appointments",
              },
              {
                endpoint: "parent-feedback",
                icon: "fa-comments",
                label: "Send Feedback",
              },
              {
                endpoint: "parent-pastoral",
                icon: "fa-handshake",
                label: "Pastoral Care",
              },
            ],
          });
          sections.push({
            title: "Finance Summary",
            items: [
              {
                endpoint: "parent-finance",
                icon: "fa-chart-pie",
                label: "Finance Dashboard",
              },
            ],
          });
          sections.push({
            title: "Account",
            items: [
              { endpoint: "profile", icon: "fa-user-cog", label: "My Profile" },
              { endpoint: "logout", icon: "fa-sign-out-alt", label: "Logout" },
            ],
          });
          renderParentDashboard(user);
        } else {
          renderError(
            "Invalid role detected. Please contact the administrator."
          );
          return;
        }

        // build menu
        sections.forEach((sec) => {
          const secEl = document.createElement("div");
          secEl.className = "menu-section";
          secEl.innerHTML = `<h5>${sec.title}</h5>`;
          sec.items.forEach((item) => {
            const a = document.createElement("a");
            a.href = "#";
            a.className = "menu-item";
            a.setAttribute("data-endpoint", item.endpoint);
            a.innerHTML = `<i class="fas ${item.icon}"></i> ${item.label}`;
            secEl.appendChild(a);
          });
          menu.appendChild(secEl);
        });
        attachMenuHandlers();
        document.getElementById("pageTitle").textContent = "Dashboard Overview";
      }

      function attachMenuHandlers() {
        document.querySelectorAll(".menu-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            e.preventDefault();
            document
              .querySelectorAll(".menu-item")
              .forEach((i) => i.classList.remove("active"));
            item.classList.add("active");
            const endpoint = item.getAttribute("data-endpoint");
            const titles = {
              dashboard: "Dashboard Overview",
              "news-feed": "News Feed & Birthdays",
              register: "Register User",
              profile: "My Profile",
              exams: "Exams",
              "add-exam": "Add Exam",
              "make-payment": "Make Payment",
              "payment-status": "Payment Status",
              events: "School Events",
              students: "All Students",
              "add-student": "Add Student",
              teachers: "All Teachers",
              "add-teacher": "Add Teacher",
              classes: "Classes",
              subjects: "Subjects",
              "mark-attendance": "Mark Attendance",
              "view-attendance": "View Attendance",
              "fee-structures": "Fee Structures",
              "fee-payments": "Fee Payments",
              "pending-fees": "Pending Fees",
              payments: "Payments",
              "admin-ai-advisor": "AI Advisor",
              // Admin endpoints
              "admin-sms": "SMS/WhatsApp",
              "admin-mailbox": "Mailbox",
              "admin-news-feed": "News Feed Management",
              "pending-messages": "Pending Messages",
              "admin-e-classroom": "E-Classroom",
              "admin-lesson-planner": "Lesson Planner",
              "admin-assignments": "Assignments Management",
              "admin-cbт": "CBT Management",
              "admin-classes": "Classes Management",
              "admin-subjects": "Subjects Management",
              "admin-exams": "Exams Management",
              "admin-hr": "HR Management",
              "admin-teachers": "Teachers Management",
              "admin-parents": "Parents Management",
              "admin-students": "Students Management",
              "admin-medicals": "Medical Records",
              "admin-talent-pool": "Talent Pool",
              "admin-visitor-mgmt": "Visitor Management",
              "admin-facilities": "Facility Management",
              "admin-photo-journals": "Photo Journals",
              "admin-attendance": "Attendance Management",
              "admin-reports": "Reports & Analytics",
              "admin-clubs": "Clubs & Societies",
              "admin-revenues": "Weekly Revenues",
              // Teacher endpoints
              "teacher-e-classroom": "E-Classroom",
              "teacher-lesson-planner": "Lesson Planner",
              "teacher-assignments": "My Assignments",
              "teacher-subjects": "My Subjects",
              "teacher-cbt": "CBT",
              "teacher-timetable": "My Timetable",
              "teacher-secondary-report": "Secondary School Report",
              "teacher-behaviour-tracker": "Behaviour Tracker",
              "teacher-pastoral": "Pastoral Care",
              "teacher-hrm": "HRM Info",
              "teacher-feedback": "Feedback & Ratings",
              // Student endpoints
              "student-rate-teacher": "Rate My Teacher",
              "student-subjects": "My Subjects",
              "student-scores": "My Scores",
              "student-cbt": "CBT",
              // Parent endpoints
              "parent-wallet": "My Wallet",
              "parent-fees": "School Fees",
              "parent-bills": "Bills & Invoices",
              "parent-store": "School Store",
              "parent-store-appointments": "Store Appointments",
              "parent-feedback": "Send Feedback",
              "parent-pastoral": "Pastoral Care",
              "parent-finance": "Finance Dashboard",
            };
            document.getElementById("pageTitle").textContent =
              titles[endpoint] || "Dashboard";
            if (endpointHandlers[endpoint]) endpointHandlers[endpoint]();
            else renderError("This section is under development.");
          });
        });
      }

      const endpointHandlers = {
        dashboard: () => {
          const role = (appState.user?.role || "").toLowerCase();
          if (role === "admin") renderAdminDashboard();
          else if (role === "student") renderStudentDashboard(appState.user);
          else if (role === "parent") renderParentDashboard(appState.user);
          else renderStaffDashboard(appState.user);
        },
        logout: () => {
          appState.token = null;
          appState.user = null;
          localStorage.removeItem("currentUser");
          location.reload();
        },
        profile: async () => {
          try {
            const data = await apiRequest("/auth/me");
            renderProfile(data);
          } catch (err) {
            renderError("Failed to load profile: " + err.message);
          }
        },
        register: () => renderRegisterForm(),
        exams: async () => {
          try {
            const data = await apiRequest("/exams");
            renderExams(data);
          } catch (err) {
            renderError("Failed to load exams: " + err.message);
          }
        },
        "add-exam": () => {
          const r = (appState.user?.role || "").toLowerCase();
          if (!["admin", "staff", "teacher"].includes(r)) {
            renderError("Access Denied");
            return;
          }
          renderAddExamForm();
        },
        "make-payment": () => {
          if ((appState.user?.role || "").toLowerCase() !== "parent") {
            renderError("Access Denied: Parents only");
            return;
          }
          renderMakePaymentForm();
        },
        "payment-status": () => {
          if ((appState.user?.role || "").toLowerCase() !== "parent") {
            renderError("Access Denied: Parents only");
            return;
          }
          renderPaymentStatus();
        },
        events: () => renderEvents(),
        "admin-ai-advisor": () => renderAdminAiAdvisor(),
        students: async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/students");
            renderStudents(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "add-student": () => {
          if ((appState.user?.role || "").toLowerCase() !== "admin") {
            renderError("Access Denied");
            return;
          }
          renderAddStudentForm();
        },
        teachers: async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/teachers");
            renderTeachers(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "add-teacher": () => {
          if ((appState.user?.role || "").toLowerCase() !== "admin") {
            renderError("Access Denied");
            return;
          }
          renderAddTeacherForm();
        },
        classes: async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/classes");
            renderClasses(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        subjects: async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/subjects");
            renderSubjects(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "mark-attendance": () => {
          if ((appState.user?.role || "").toLowerCase() !== "admin") {
            renderError("Access Denied");
            return;
          }
          renderMarkAttendance();
        },
        "view-attendance": () => {
          if ((appState.user?.role || "").toLowerCase() !== "admin") {
            renderError("Access Denied");
            return;
          }
          renderViewAttendance();
        },
        "fee-structures": async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/fee-structures");
            renderFeeStructures(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "fee-payments": async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/fee-payments");
            renderFeePayments(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "pending-fees": async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const data = await apiRequest("/fee-payments/pending");
            renderPendingFees(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        payments: async () => {
          try {
            if ((appState.user?.role || "").toLowerCase() !== "admin") {
              renderError("Access Denied");
              return;
            }
            const res = await apiRequest("/payments");
            // server returns { total, page, per_page, payments: [...] }
            const list = Array.isArray(res) ? res : res.payments || [];
            renderPayments(list, res);
          } catch (err) {
            renderError(err.message || String(err));
          }
        },
        // New demo handlers for dashboard widgets
        "class-distribution": async () => {
          try {
            const res = await apiRequest("/reports/class-distribution");
            if (res && res.labels && res.counts) {
              drawBarChart("classChart", res.labels, res.counts);
              showAlert("loginAlert", "Class distribution loaded", "success");
            } else {
              renderError("No class distribution data available");
            }
          } catch (err) {
            renderError(err.message || String(err));
          }
        },
        "store-catalog": async () => {
          try {
            const res = await apiRequest("/store/catalog");
            renderStoreCatalog(res.items || []);
          } catch (err) {
            renderError(err.message || String(err));
          }
        },
        "view-cart": async () => {
          try {
            const res = await apiRequest("/store/cart");
            renderCart(res.items || []);
          } catch (err) {
            renderError(err.message || String(err));
          }
        },
        "news-birthdays": async () => {
          try {
            const res = await apiRequest("/news/birthdays");
            renderBirthdays(res.birthdays || []);
          } catch (err) {
            renderError(err.message || String(err));
          }
        },
        // ADMIN endpoints
        "news-feed": async () => {
          try {
            const res = await apiRequest("/news/birthdays");
            renderNewsFeedWithBirthdays(res.birthdays || []);
          } catch (err) {
            renderError(err.message || String(err));
          }
        },
        "admin-sms": () => renderAdminSMS(),
        "admin-mailbox": () => renderAdminMailbox(),
        "admin-news-feed": () => renderAdminNewsFeed(),
        "pending-messages": () => renderAdminPendingMessages(),
        "admin-e-classroom": () => renderAdminEClassroom(),
        "admin-lesson-planner": () => renderAdminLessonPlanner(),
        "admin-assignments": () => renderAdminAssignments(),
        "admin-cbт": () => renderAdminCBT(),
        "admin-classes": async () => {
          try {
            const data = await apiRequest("/classes");
            renderAdminClasses(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-subjects": async () => {
          try {
            const data = await apiRequest("/subjects");
            renderAdminSubjects(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-exams": async () => {
          try {
            const data = await apiRequest("/exams");
            renderAdminExams(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-hr": () => renderAdminHR(),
        "admin-teachers": async () => {
          try {
            const data = await apiRequest("/teachers");
            renderAdminTeachers(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-parents": () => renderAdminParents(),
        "admin-students": async () => {
          try {
            const data = await apiRequest("/students");
            renderAdminStudents(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-medicals": () => renderAdminMedicals(),
        "admin-talent-pool": () => renderAdminTalentPool(),
        "admin-visitor-mgmt": () => renderAdminVisitorMgmt(),
        "admin-facilities": () => renderAdminFacilities(),
        "admin-photo-journals": () => renderAdminPhotoJournals(),
        "admin-attendance": async () => {
          try {
            const data = await apiRequest("/attendance");
            renderAdminAttendance(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-reports": async () => {
          try {
            const data = await apiRequest("/reports/class-distribution");
            renderAdminReports(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        "admin-clubs": () => renderAdminClubs(),
        "admin-revenues": async () => {
          try {
            const data = await apiRequest("/payments");
            renderAdminRevenues(data);
          } catch (err) {
            renderError(err.message);
          }
        },
        // TEACHER endpoints
        "teacher-e-classroom": () => renderTeacherEClassroom(),
        "teacher-lesson-planner": () => renderTeacherLessonPlanner(),
        "teacher-assignments": () => renderTeacherAssignments(),
        "teacher-subjects": () => renderTeacherSubjects(),
        "teacher-cbt": () => renderTeacherCBT(),
        "teacher-timetable": () => renderTeacherTimetable(),
        "teacher-secondary-report": () => renderTeacherSecondaryReport(),
        "teacher-behaviour-tracker": () => renderTeacherBehaviourTracker(),
        "teacher-pastoral": () => renderTeacherPastoral(),
        "teacher-hrm": () => renderTeacherHRM(),
        "teacher-feedback": () => renderTeacherFeedback(),
        // STUDENT endpoints
        "student-rate-teacher": () => renderStudentRateTeacher(),
        "student-subjects": () => renderStudentSubjects(),
        "student-scores": () => renderStudentScores(),
        "student-cbt": () => renderStudentCBT(),
        // PARENT endpoints
        "parent-wallet": () => renderParentWallet(),
        "parent-fees": () => renderParentFees(),
        "parent-bills": () => renderParentBills(),
        "parent-store": async () => {
          window.open("/store", "_blank");
        },
        "parent-store-appointments": () => renderParentStoreAppointments(),
        "parent-feedback": () => renderParentFeedback(),
        "parent-pastoral": () => renderParentPastoral(),
        "parent-finance": () => renderParentFinance(),
      };

      // Global store endpoint to open standalone store UI
      endpointHandlers["store"] = () => {
        window.open("/store", "_blank");
      };

      // minimal dashboards and renderers reused
      function renderAdminDashboard() {
        document.getElementById("pageTitle").textContent = "Admin Dashboard";
        document.getElementById("contentArea").innerHTML = `
          <div class="stats-grid">
            <div class="stat-card"><div class="icon" style="background:rgba(99,102,241,0.1);color:#6366f1"><i class="fas fa-users"></i></div><h3 id="totalStudents">-</h3><p>Total Students</p></div>
            <div class="stat-card"><div class="icon" style="background:rgba(245,158,11,0.1);color:#f59e0b"><i class="fas fa-chalkboard-teacher"></i></div><h3 id="totalTeachers">-</h3><p>Total Teachers</p></div>
            <div class="stat-card"><div class="icon" style="background:rgba(16,185,129,0.1);color:#10b981"><i class="fas fa-door-open"></i></div><h3 id="totalClasses">-</h3><p>Total Classes</p></div>
            <div class="stat-card"><div class="icon" style="background:rgba(239,68,68,0.1);color:#ef4444"><i class="fas fa-exclamation-circle"></i></div><h3 id="pendingFees">-</h3><p>Pending Fees</p></div>
          </div>

          <div class="row g-3">
            <div class="col-lg-7">
              <div class="card">
                <div class="card-header"><i class="fas fa-table"></i> Store Analytics</div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped mb-0">
                      <thead class="table-light"><tr><th>Item</th><th>Sales</th><th>Revenue (₦)</th></tr></thead>
                      <tbody id="analyticsPopularItems"><tr><td colspan="3" class="text-center text-muted">Loading...</td></tr></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="card" id="advisorSection">
                <div class="card-header"><i class="fas fa-robot"></i> AI Advisor</div>
                <div class="card-body">
                  <p class="text-muted mb-2">Unified academic & operational metrics with intelligent suggestions.</p>
                  <div id="advisorLoading" class="py-2 text-center">Loading analytics...</div>
                  <div id="advisorError" class="alert alert-danger d-none"></div>
                  <div id="advisorKpis" class="d-none" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:15px"></div>
                  <div id="advisorCharts" class="d-none" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:15px;margin-bottom:15px"></div>
                  <div id="advisorInsights" class="d-none">
                    <h6 class="mb-2"><i class="fas fa-lightbulb me-1"></i> Improvement Tips</h6>
                    <ul id="insightList" class="list-unstyled mb-0" style="display:grid;gap:8px"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card mt-3 p-3">
            <h6 class="mb-2">Insights</h6>
            <div style="width:100%;max-width:720px;"><canvas id="classChart" width="720" height="200"></canvas></div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-sm btn-outline-primary" onclick="endpointHandlers['class-distribution']()">Refresh Class Distribution</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="endpointHandlers['news-birthdays']()">Upcoming Birthdays</button>
              <button class="btn btn-sm btn-outline-success" onclick="endpointHandlers['store-catalog']()">Open Store</button>
            </div>
          </div>
        `;
        loadDashboardStats();
        // Load analytics and advisor
        (async () => {
          try {
            const analytics = await apiRequest("/analytics/store");
            const tbody = document.getElementById("analyticsPopularItems");
            tbody.innerHTML =
              (analytics.popular_items || [])
                .map(
                  (it) => `
              <tr><td>${it.name}</td><td>${it.sales}</td><td>${
                    (it.revenue ?? 0).toLocaleString?.() || it.revenue
                  }</td></tr>
            `
                )
                .join("") ||
              '<tr><td colspan="3" class="text-center text-muted">No data</td></tr>';
          } catch (e) {}
          // Use unified AI Advisor analytics snippet
          fetchAdvisorAnalytics();
        })();
      }
      // Detailed AI Advisor view
      function renderAdminAiAdvisor() {
        document.getElementById("pageTitle").textContent = "AI Advisor";
        const el = document.getElementById("contentArea");
        el.innerHTML = `
          <div class="card mb-3">
            <div class="card-header"><i class="fas fa-robot"></i> AI Advisor Overview</div>
            <div class="card-body">
              <p class="text-muted mb-2">Comprehensive academic, operational and commercial metrics with improvement insights.</p>
              <div id="aiAdvisorError" class="alert alert-danger d-none"></div>
              <div id="aiAdvisorLoading" class="text-center py-3">Loading analytics...</div>
              <div id="aiAdvisorKpis" class="row g-3 d-none"></div>
              <div id="aiAdvisorCharts" class="row g-3 d-none"></div>
              <div id="aiAdvisorInsights" class="mt-3 d-none">
                <h6><i class="fas fa-lightbulb me-1"></i> Improvement Tips</h6>
                <ul id="aiAdvisorInsightList" class="list-unstyled mb-0"></ul>
              </div>
            </div>
          </div>`;
        loadAdminAiAdvisor();
      }
      async function loadAdminAiAdvisor(days = 30) {
        const token = appState.token;
        const errEl = document.getElementById("aiAdvisorError");
        const loadEl = document.getElementById("aiAdvisorLoading");
        const kpiRow = document.getElementById("aiAdvisorKpis");
        const chartsRow = document.getElementById("aiAdvisorCharts");
        const insightsWrap = document.getElementById("aiAdvisorInsights");
        const insightList = document.getElementById("aiAdvisorInsightList");
        if (!token) {
          errEl.textContent = "Authentication required.";
          errEl.classList.remove("d-none");
          loadEl.classList.add("d-none");
          return;
        }
        try {
          const data = await apiRequest(`/advisor/detailed?days=${days}`);
          loadEl.classList.add("d-none");
          renderAdminAdvisorKpis(data.totals, kpiRow);
          renderAdminAdvisorCharts(data, chartsRow);
          renderAdminAdvisorInsights(data.insights || [], insightList);
          kpiRow.classList.remove("d-none");
          chartsRow.classList.remove("d-none");
          insightsWrap.classList.remove("d-none");
        } catch (e) {
          loadEl.classList.add("d-none");
          errEl.textContent = e.message;
          errEl.classList.remove("d-none");
        }
      }
      function renderAdminAdvisorKpis(totals, row) {
        if (!totals || !row) return;
        const defs = [
          ["students", "Students"],
          ["teachers", "Teachers"],
          ["teacher_student_ratio", "Teacher/Student"],
          ["attendance_rate", "Attendance %"],
          ["exam_pass_rate", "Exam Pass %"],
          ["unpaid_fees", "Unpaid Fees"],
          ["store_revenue", "Store Revenue"],
          ["avg_class_size", "Avg Class Size"],
        ];
        row.innerHTML = defs
          .map(([k, label]) => {
            let val = totals[k];
            if (k.includes("rate")) val = Math.round(val * 100) / 100;
            return `<div class="col-sm-6 col-md-3"><div class="p-3 border rounded bg-white h-100"><div class="small text-muted">${label}</div><div class="fw-bold fs-5">${
              val ?? 0
            }</div></div></div>`;
          })
          .join("");
      }
      function renderAdminAdvisorCharts(data, row) {
        if (!row) return;
        const grade = data.grade_distribution || {};
        const sentiment = data.sentiment_distribution || {};
        const storePerf = data.store_performance || [];
        row.innerHTML = `
          <div class="col-md-4"><div class="p-3 border rounded bg-white"><h6 class="mb-2">Grade Distribution</h6>${barList(
            grade
          )}</div></div>
          <div class="col-md-4"><div class="p-3 border rounded bg-white"><h6 class="mb-2">Review Sentiment</h6>${barList(
            sentiment
          )}</div></div>
          <div class="col-md-4"><div class="p-3 border rounded bg-white"><h6 class="mb-2">Top Store Items</h6>${storeItemsList(
            storePerf
          )}</div></div>`;
      }
      function barList(obj) {
        if (!Object.keys(obj).length)
          return '<div class="text-muted small">No data</div>';
        const maxVal = Math.max(1, ...Object.values(obj));
        return Object.entries(obj)
          .map(
            ([k, v]) =>
              `<div class="mb-1"><div class="small">${k}</div><div class="progress" style="height:6px"><div class="progress-bar bg-primary" style="width:${
                (v / maxVal) * 100
              }%"></div></div><div class="small text-muted">${v}</div></div>`
          )
          .join("");
      }
      function storeItemsList(rows) {
        if (!rows.length)
          return '<div class="text-muted small">No completed orders</div>';
        return rows
          .map(
            (r) =>
              `<div class="d-flex justify-content-between small border rounded p-1 mb-1"><span class="fw-semibold">${
                r.title
              }</span><span>${
                r.quantity_sold
              } sold</span><span>₦${r.revenue.toFixed(2)}</span></div>`
          )
          .join("");
      }
      function renderAdminAdvisorInsights(insights, ul) {
        if (!ul) return;
        ul.innerHTML =
          insights
            .map(
              (i) =>
                `<li class="border rounded p-2 mb-2"><div class="small text-uppercase text-secondary fw-semibold">${
                  i.category || "general"
                }</div><div>${i.insight_text}</div></li>`
            )
            .join("") ||
          '<li class="text-muted small">No insights available.</li>';
      }
      // --- Embedded AI Advisor snippet functions (for admin dashboard) ---
      async function fetchAdvisorAnalytics(days = 30) {
        const loading = document.getElementById("advisorLoading");
        const errorEl = document.getElementById("advisorError");
        const kpiWrap = document.getElementById("advisorKpis");
        const chartsWrap = document.getElementById("advisorCharts");
        const insightsWrap = document.getElementById("advisorInsights");
        const insightList = document.getElementById("insightList");
        const token = localStorage.getItem("currentToken") || appState.token;
        if (!token) {
          loading?.classList.add("d-none");
          if (errorEl) {
            errorEl.textContent =
              "Admin login required to view operational analytics.";
            errorEl.classList.remove("d-none");
          }
          return;
        }
        try {
          const res = await fetch(`/advisor/detailed?days=${days}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error(`Request failed (${res.status})`);
          const data = await res.json();
          loading?.classList.add("d-none");
          renderAdvisorKPIs(data.totals, kpiWrap);
          renderAdvisorCharts(data);
          renderAdvisorInsights(data.insights || [], insightList);
          kpiWrap?.classList.remove("d-none");
          chartsWrap?.classList.remove("d-none");
          insightsWrap?.classList.remove("d-none");
        } catch (err) {
          loading?.classList.add("d-none");
          if (errorEl) {
            errorEl.textContent = `Failed to load analytics: ${err.message}`;
            errorEl.classList.remove("d-none");
          }
        }
      }
      function renderAdvisorKPIs(totals, container) {
        if (!totals || !container) return;
        const defs = [
          { key: "students", label: "Students" },
          { key: "teachers", label: "Teachers" },
          { key: "teacher_student_ratio", label: "Teacher/Student" },
          { key: "attendance_rate", label: "Attendance %" },
          { key: "exam_pass_rate", label: "Exam Pass %" },
          { key: "unpaid_fees", label: "Unpaid Fees" },
          { key: "store_revenue", label: "Store Revenue" },
          { key: "avg_class_size", label: "Avg Class Size" },
        ];
        container.innerHTML = defs
          .map((d) => {
            const valRaw = totals[d.key];
            let val = typeof valRaw === "number" ? valRaw : valRaw || 0;
            if (d.key.includes("rate")) val = Math.round(val * 100) / 100;
            return `<div style="background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
                <div style="font-size:11px; color:#666;">${d.label}</div>
                <div style="font-size:18px; font-weight:600; color:#2c3e50;">${val}</div>
            </div>`;
          })
          .join("");
      }
      function renderAdvisorCharts(data) {
        const chartsWrap = document.getElementById("advisorCharts");
        if (!chartsWrap) return;
        const gradeDist = data.grade_distribution || {};
        const sentiment = data.sentiment_distribution || {};
        const storePerf = data.store_performance || [];
        chartsWrap.innerHTML = "";
        chartsWrap.appendChild(simpleBarChart("Grade Distribution", gradeDist));
        chartsWrap.appendChild(
          simpleBarChart("Review Sentiment (Rating)", sentiment)
        );
        chartsWrap.appendChild(storePerformanceBlock(storePerf));
      }
      function simpleBarChart(title, obj) {
        const maxVal = Math.max(1, ...Object.values(obj));
        const el = document.createElement("div");
        el.style.background = "#fff";
        el.style.border = "1px solid #e0e0e0";
        el.style.borderRadius = "10px";
        el.style.padding = "15px";
        el.style.boxShadow = "0 4px 12px rgba(0,0,0,0.05)";
        el.innerHTML = `<h4 style="font-size:14px; margin:0 0 8px; color:#333;">${title}</h4>`;
        const wrap = document.createElement("div");
        wrap.style.display = "grid";
        wrap.style.gap = "6px";
        Object.entries(obj).forEach(([k, v]) => {
          const row = document.createElement("div");
          row.innerHTML = `<div style='font-size:11px; color:#555;'>${k}</div>
            <div style='background:#eef2ff; height:8px; border-radius:4px; position:relative;'>
              <div style='position:absolute; top:0; left:0; height:100%; width:${
                (v / maxVal) * 100
              }%; background:linear-gradient(90deg,#667eea,#764ba2); border-radius:4px;'></div>
            </div>
            <div style='font-size:10px; color:#777;'>${v}</div>`;
          row.style.display = "grid";
          row.style.gridTemplateColumns = "60px 1fr 28px";
          row.style.alignItems = "center";
          wrap.appendChild(row);
        });
        if (!Object.keys(obj).length) {
          wrap.innerHTML =
            '<div style="font-size:11px; color:#777;">No data</div>';
        }
        el.appendChild(wrap);
        return el;
      }
      function storePerformanceBlock(rows) {
        const el = document.createElement("div");
        el.style.background = "#fff";
        el.style.border = "1px solid #e0e0e0";
        el.style.borderRadius = "10px";
        el.style.padding = "15px";
        el.style.boxShadow = "0 4px 12px rgba(0,0,0,0.05)";
        el.innerHTML = `<h4 style="font-size:14px; margin:0 0 8px; color:#333;">Top Store Items</h4>`;
        const list = document.createElement("div");
        list.style.display = "grid";
        list.style.gap = "8px";
        if (!rows.length) {
          list.innerHTML =
            '<div style="font-size:11px; color:#777;">No completed orders</div>';
        } else {
          rows.forEach((r) => {
            const item = document.createElement("div");
            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.style.fontSize = "11px";
            item.style.padding = "6px 8px";
            item.style.background = "#fafafa";
            item.style.borderRadius = "6px";
            item.innerHTML = `<span style='font-weight:600;'>${
              r.title
            }</span><span>${
              r.quantity_sold
            } sold</span><span style='color:#2c3e50;'>₦${r.revenue.toFixed(
              2
            )}</span>`;
            list.appendChild(item);
          });
        }
        el.appendChild(list);
        return el;
      }
      function renderAdvisorInsights(insights, ul) {
        if (!ul) return;
        ul.innerHTML = "";
        if (!insights.length) {
          ul.innerHTML =
            '<li style="font-size:12px; color:#777;">No insights available. System needs more data.</li>';
          return;
        }
        insights.forEach((i) => {
          const li = document.createElement("li");
          li.style.padding = "10px 12px";
          li.style.background = "#fff";
          li.style.border = "1px solid #e0e0e0";
          li.style.borderRadius = "8px";
          li.style.boxShadow = "0 2px 6px rgba(0,0,0,0.05)";
          li.innerHTML = `<div style='font-size:11px; color:#764ba2; font-weight:600; margin-bottom:4px;'>${(
            i.category || "general"
          ).toUpperCase()}</div>
            <div style='font-size:13px; color:#2c3e50; line-height:1.4;'>${
              i.insight_text
            }</div>`;
          ul.appendChild(li);
        });
      }
      function renderStaffDashboard(user) {
        document.getElementById("pageTitle").textContent = "Staff Dashboard";
        document.getElementById(
          "contentArea"
        ).innerHTML = `<div class="alert alert-success"><i class="fas fa-user-check"></i> <strong>Welcome, ${user.full_name}!</strong></div><div class="card mt-4"><div class="card-body"><h5 class="card-title"><i class="fas fa-info-circle"></i> Your Access</h5><p class="card-text">As a staff member, you can view exams and create new exams.</p></div></div>`;
      }
      function renderStudentDashboard(user) {
        document.getElementById("pageTitle").textContent = "Student Dashboard";
        document.getElementById("contentArea").innerHTML = `
          <div class="alert alert-success"><i class="fas fa-graduation-cap"></i> <strong>Welcome back, ${user.full_name}!</strong></div>
          <div class="card mt-4"><div class="card-body"><h5 class="card-title"><i class="fas fa-info-circle"></i> Your Portal</h5><p class="card-text">You can view your exams and edit your profile.</p>
            <div class="mt-3"><button class="btn btn-primary btn-sm" onclick="showStudentProgress()"><i class="fas fa-chart-line me-2"></i> View My Progress</button></div>
          </div></div>
        `;
      }
      function renderParentDashboard(user) {
        document.getElementById("pageTitle").textContent = "Parent Dashboard";
        document.getElementById("contentArea").innerHTML = `
          <div class="alert alert-info"><i class="fas fa-users"></i> <strong>Welcome, ${user.full_name}!</strong></div>
          <div class="row mt-4">
            <div class="col-md-4 mb-3">
              <div class="card text-center h-100">
                <div class="card-body">
                  <div class="icon mb-3" style="background:rgba(99,102,241,0.1);color:#6366f1;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto;"><i class="fas fa-wallet fa-2x"></i></div>
                  <h5 class="card-title">Make Payments</h5>
                  <p class="card-text">Pay school fees online securely</p>
                  <button class="btn btn-primary btn-sm" onclick="endpointHandlers['make-payment']()">Go to Payments</button>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card text-center h-100">
                <div class="card-body">
                  <div class="icon mb-3" style="background:rgba(16,185,129,0.1);color:#10b981;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto;"><i class="fas fa-receipt fa-2x"></i></div>
                  <h5 class="card-title">Payment Status</h5>
                  <p class="card-text">View your payment history</p>
                  <button class="btn btn-success btn-sm" onclick="endpointHandlers['payment-status']()">Check Status</button>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card text-center h-100">
                <div class="card-body">
                  <div class="icon mb-3" style="background:rgba(245,158,11,0.1);color:#f59e0b;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto;"><i class="fas fa-calendar-alt fa-2x"></i></div>
                  <h5 class="card-title">School Events</h5>
                  <p class="card-text">View upcoming school events</p>
                  <button class="btn btn-warning btn-sm" onclick="endpointHandlers['events']()">View Events</button>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card text-center h-100">
                <div class="card-body">
                  <div class="icon mb-3" style="background:rgba(99,102,241,0.1);color:#6366f1;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto;"><i class="fas fa-store fa-2x"></i></div>
                  <h5 class="card-title">School Store</h5>
                  <p class="card-text">Buy school merch and books</p>
                  <button class="btn btn-primary btn-sm" onclick="endpointHandlers['store-catalog']()">Open Store</button>
                </div>
              </div>
            </div>
            <div class="col-md-12 mt-3">
              <div class="card p-3 text-center">
                <h5 class="card-title">Child Progress</h5>
                <p class="card-text">View your child's exam and grade progress.</p>
                <div class="d-flex justify-content-center gap-2">
                  <input id="childIdInput" class="form-control form-control-sm" placeholder="Enter Child ID" style="max-width:320px;" />
                  <button class="btn btn-primary btn-sm" onclick="viewChildById()"><i class="fas fa-search me-2"></i> View</button>
                  <button class="btn btn-outline-primary btn-sm" onclick="showChildProgressModal()"><i class="fas fa-list me-2"></i> Select</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Allow parent to enter a child ID and view progress (will be authorized by server)
      async function viewChildById() {
        const input = document.getElementById("childIdInput");
        const id = input && input.value && input.value.trim();
        if (!id) {
          showAlert("loginAlert", "Enter a valid Child ID", "danger");
          return;
        }
        try {
          const res = await apiRequest(
            `/grades/student/${encodeURIComponent(id)}`
          );
          const content = document.getElementById("contentArea");
          if (!res || (Array.isArray(res) && res.length === 0)) {
            content.innerHTML = `<div class="alert alert-info">No grades found for this student.</div>`;
            return;
          }
          // render grades (array of grade objects)
          const rows = (Array.isArray(res) ? res : res.grades || [])
            .map(
              (g) =>
                `<tr><td>${g.exam?.name || g.exam_id || "Exam"}</td><td>${
                  g.marks_obtained ?? "-"
                }</td><td>${g.percentage ?? "-"}</td><td>${
                  g.grade_letter ?? "-"
                }</td><td>${g.is_passed ? "Yes" : "No"}</td></tr>`
            )
            .join("");
          content.innerHTML = `<h3><i class="fas fa-chart-line"></i> Child Progress</h3><hr><div class="table-responsive"><table class="table"><thead><tr><th>Exam</th><th>Marks</th><th>%</th><th>Grade</th><th>Passed</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
        const av = document.getElementById("userAvatar");
        if (av) (av.style.cursor = "pointer"), (av.onclick = openProfileModal);
      }

      async function loadDashboardStats() {
        try {
          const data = await apiRequest("/dashboard/stats");
          const s = document.getElementById("totalStudents");
          const t = document.getElementById("totalTeachers");
          const c = document.getElementById("totalClasses");
          const p = document.getElementById("pendingFees");
          if (s) s.textContent = data.total_students || 0;
          if (t) t.textContent = data.total_teachers || 0;
          if (c) c.textContent = data.total_classes || 0;
          if (p) p.textContent = data.pending_fee_students || 0;
        } catch (err) {
          console.error("stats error", err);
        }
      }

      // Lightweight helper to adjust in-page header badges without full reload
      // Header badges are updated optimistically here. For authoritative
      // dashboard KPI values we always re-fetch the server stats.
      function adjustCountBadge(id, delta) {
        const el = document.getElementById(id);
        if (!el) return;
        const current =
          parseInt((el.textContent || "0").replace(/[^0-9-]/g, ""), 10) || 0;
        const next = Math.max(0, current + (Number(delta) || 0));
        el.textContent = String(next);
        // Trigger a background refresh of dashboard stats so tiles show
        // authoritative server-backed values (avoids client-side drift).
        try {
          if (typeof loadDashboardStats === "function") {
            // Fire-and-forget; swallow any errors
            loadDashboardStats().catch(() => {});
          }
        } catch (e) {
          // ignore
        }
      }

      // Simple canvas bar chart renderer (no external libs)
      function drawBarChart(canvasId, labels, data) {
        const c = document.getElementById(canvasId);
        if (!c) return;
        const ctx = c.getContext("2d");
        const width = c.width;
        const height = c.height;
        ctx.clearRect(0, 0, width, height);
        if (!labels || !data || labels.length === 0) {
          ctx.fillStyle = "#666";
          ctx.fillText("No data", 10, 20);
          return;
        }
        const max = Math.max(...data, 1);
        const barWidth = Math.floor((width - 40) / data.length);
        labels.forEach((lbl, i) => {
          const val = data[i] || 0;
          const h = Math.round((val / max) * (height - 40));
          const x = 20 + i * barWidth;
          const y = height - 20 - h;
          ctx.fillStyle = "#4f46e5";
          ctx.fillRect(x + 6, y, barWidth - 12, h);
          ctx.fillStyle = "#111827";
          ctx.font = "12px sans-serif";
          ctx.fillText(lbl, x + 6, height - 4);
          ctx.fillText(String(val), x + 6, y - 6);
        });
      }

      // Store / Cart UI renderers
      function renderStoreCatalog(items) {
        document.getElementById("pageTitle").textContent = "School Store";
        const html = `<div class="row">${items
          .map(
            (it) =>
              `<div class="col-md-4 mb-3"><div class="card"><img src="${
                it.image_url || "/static/fair-educare/img/placeholder.png"
              }" class="card-img-top" style="height:160px;object-fit:cover"/><div class="card-body text-center"><h6>${
                it.title
              }</h6><p class="mb-1">NGN ${
                it.price
              }</p><button class="btn btn-sm btn-primary" onclick="addToCart('${
                it.id
              }')">Add to cart</button></div></div></div>`
          )
          .join("")}</div>`;
        document.getElementById("contentArea").innerHTML =
          html +
          `<div class="mt-3"><button class="btn btn-success" onclick="endpointHandlers['view-cart']()">View Cart</button></div>`;
      }

      async function addToCart(itemId) {
        try {
          await apiRequest("/store/cart", {
            method: "POST",
            body: JSON.stringify({ item_id: itemId, qty: 1 }),
          });
          showAlert("loginAlert", "Item added to cart", "success");
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
      }

      function renderCart(items) {
        document.getElementById("pageTitle").textContent = "My Store Cart";
        if (!items || items.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">Your cart is empty.</div>`;
          return;
        }
        const rows = items
          .map(
            (it) =>
              `<tr><td>${it.title}</td><td>${it.qty}</td><td>NGN ${
                it.price
              }</td><td>NGN ${it.qty * it.price}</td></tr>`
          )
          .join("");
        document.getElementById(
          "contentArea"
        ).innerHTML = `<h3>My Cart</h3><div class="table-responsive"><table class="table"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr></thead><tbody>${rows}</tbody></table></div><div class="text-end"><button class="btn btn-primary" onclick="checkoutCart()">Checkout</button></div>`;
      }

      async function checkoutCart() {
        try {
          const res = await apiRequest("/store/checkout", { method: "POST" });
          showAlert(
            "loginAlert",
            `Checkout complete. Total: NGN ${res.total}`,
            "success"
          );
          endpointHandlers.dashboard();
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
      }

      function renderBirthdays(list) {
        document.getElementById("pageTitle").textContent = "Upcoming Birthdays";
        if (!list || list.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">No birthdays in the next 30 days.</div>`;
          return;
        }
        const items = list
          .map(
            (b) =>
              `<li class="list-group-item"><strong>${
                b.name
              }</strong> <span class="text-muted">(${
                b.type
              })</span> — ${new Date(b.date).toLocaleDateString()}</li>`
          )
          .join("");
        document.getElementById(
          "contentArea"
        ).innerHTML = `<h3>Upcoming Birthdays</h3><ul class="list-group mt-3">${items}</ul>`;
      }

      function renderError(msg) {
        document.getElementById(
          "contentArea"
        ).innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${msg}</div>`;
      }

      function renderProfile(data) {
        const canEdit = true;
        document.getElementById("pageTitle").textContent = "My Profile";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-user"></i> My Profile</h3>
          <hr>
          <div class="card mb-4"><div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div id="profilePageAvatar" style="width:120px;height:120px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;background:#eef;color:#555;"></div>
              <div class="ms-3">
                <button type="button" class="btn btn-sm btn-primary me-2" onclick="triggerProfileAvatarUpload()"><i class="fas fa-upload"></i> Upload Photo</button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAvatar()"><i class="fas fa-trash"></i> Remove Photo</button>
                <input type="file" id="profileAvatarFileInput" accept="image/*" class="d-none" />
                <div id="profileAvatarStatus" class="small text-muted mt-1"></div>
              </div>
            </div>
            <div class="row"><div class="col-md-6">
              <p><strong>Name:</strong> ${data.full_name}</p>
              <p><strong>Email:</strong> ${data.email}</p>
              <p><strong>Role:</strong> <span class="badge bg-primary">${
                data.role
              }</span></p>
              <p><strong>Phone:</strong> ${data.phone || "N/A"}</p>
              <p><strong>Status:</strong> ${
                data.is_active
                  ? '<span class="badge bg-success">Active</span>'
                  : '<span class="badge bg-danger">Inactive</span>'
              }</p>
            </div></div>
            ${
              canEdit
                ? `<hr><h5>Update Profile</h5>
            <form id="updateProfileForm"><div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name</label>
                <input class="form-control" name="full_name" value="${
                  data.full_name || ""
                }" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone</label>
                <input class="form-control" name="phone" value="${
                  data.phone || ""
                }">
              </div>
              <div class="col-12"><button class="btn btn-primary">Save</button></div>
            </div></form>`
                : ""
            }
          </div></div>
        `;
        const avDiv = document.getElementById("profilePageAvatar");
        if (avDiv) {
          const resolved = resolvePhotoUrl(data.photo_url);
          if (resolved) {
            avDiv.innerHTML = `<img src="${resolved}" alt="avatar" style="width:100%;height:100%;object-fit:cover;"/>`;
          } else {
            const letter = (data.full_name || data.email || "?")
              .charAt(0)
              .toUpperCase();
            avDiv.textContent = letter;
          }
        }
        if (canEdit) {
          document
            .getElementById("updateProfileForm")
            ?.addEventListener("submit", async (e) => {
              e.preventDefault();
              const fd = new FormData(e.target);
              const payload = {};
              for (const [k, v] of fd.entries())
                if (v.trim() !== "") payload[k] = v;
              try {
                await apiRequest("/auth/me", {
                  method: "PUT",
                  body: JSON.stringify(payload),
                });
                showAlert("loginAlert", "Profile updated", "success");
                endpointHandlers.profile();
              } catch (err) {
                showAlert("loginAlert", err.message || String(err));
              }
            });
        }
      }

      async function renderExams(data) {
        document.getElementById("pageTitle").textContent = "Exams";
        if (!data || data.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info"><i class="fas fa-info-circle"></i> No exams found.</div>`;
          return;
        }
        const canAdd = ["admin", "staff", "teacher"].includes(
          (appState.user?.role || "").toLowerCase()
        );
        document.getElementById(
          "contentArea"
        ).innerHTML = `<div class="d-flex justify-content-between align-items-center mb-4"><h3><i class="fas fa-file-alt"></i> Exams (${
          data.length
        })</h3>${
          canAdd
            ? `<button class="btn btn-primary" onclick="endpointHandlers['add-exam']()"><i class="fas fa-plus"></i> Add Exam</button>`
            : ""
        }</div><div class="table-responsive"><table class="table"><thead><tr><th>Name</th><th>Date</th><th>Total Marks</th><th>Passing Marks</th></tr></thead><tbody>${data
          .map(
            (ex) =>
              `<tr><td>${ex.name || "N/A"}</td><td>${
                ex.date ? new Date(ex.date).toLocaleDateString() : "N/A"
              }</td><td>${ex.total_marks || 0}</td><td>${
                ex.passing_marks || 0
              }</td></tr>`
          )
          .join("")}</tbody></table></div>`;
      }

      function renderAddExamForm() {
        document.getElementById("pageTitle").textContent = "Add Exam";
        document.getElementById(
          "contentArea"
        ).innerHTML = `<h3><i class="fas fa-plus-circle"></i> Add New Exam</h3><hr><div id="addExamAlert"></div><form id="addExamForm"><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Exam Name *</label><input type="text" class="form-control" name="name" required></div><div class="col-md-6 mb-3"><label class="form-label">Date *</label><input type="date" class="form-control" name="date" required></div><div class="col-md-6 mb-3"><label class="form-label">Total Marks *</label><input type="number" class="form-control" name="total_marks" required min="0"></div><div class="col-md-6 mb-3"><label class="form-label">Passing Marks *</label><input type="number" class="form-control" name="passing_marks" required min="0"></div><div class="col-12"><button class="btn btn-primary">Create Exam</button></div></div></form>`;
        document
          .getElementById("addExamForm")
          ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {};
            for (const [k, v] of fd.entries())
              if (v.trim() !== "") payload[k] = v;
            try {
              await apiRequest("/exams", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              document.getElementById(
                "addExamAlert"
              ).innerHTML = `<div class="alert alert-success">Exam created.</div>`;
              e.target.reset();
            } catch (err) {
              document.getElementById(
                "addExamAlert"
              ).innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
          });
      }

      // parent pages
      function renderMakePaymentForm() {
        document.getElementById("pageTitle").textContent = "Make Payment";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-wallet"></i> Make Payment</h3>
          <hr>
          <div id="paymentAlert" class="alert d-none"></div>
          <form id="paymentForm">
            <div class="mb-3">
              <label class="form-label">Payer Name</label>
              <input type="text" id="payName" class="form-control" value="${
                (appState.user &&
                  (appState.user.full_name || appState.user.name)) ||
                ""
              }" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Payer Email</label>
              <input type="email" id="payEmail" class="form-control" value="${
                (appState.user && appState.user.email) || ""
              }" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Amount (NGN)</label>
              <input type="number" id="payAmount" class="form-control" min="50" value="1000" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <input type="text" id="payDesc" class="form-control" placeholder="e.g. Termly fees" />
            </div>
            <button class="btn btn-primary" id="startPaymentBtn">Pay Now</button>
          </form>
        `;

        // attach handler
        document
          .getElementById("paymentForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("payName").value.trim();
            const email = document.getElementById("payEmail").value.trim();
            const amount = parseInt(
              document.getElementById("payAmount").value,
              10
            );
            const desc = document.getElementById("payDesc").value.trim();
            const alertEl = document.getElementById("paymentAlert");
            alertEl.classList.add("d-none");

            if (!email || !amount || amount <= 0) {
              alertEl.textContent = "Enter a valid email and amount";
              alertEl.className = "alert alert-danger";
              alertEl.classList.remove("d-none");
              return;
            }

            try {
              document.getElementById("startPaymentBtn").disabled = true;
              const payload = { email, amount, name };
              const res = await apiRequest("/payments/initialize", {
                method: "POST",
                body: JSON.stringify(payload),
              });

              // Backend returns payment_url - open it so parent completes payment on Paystack
              if (res && res.payment_url) {
                // open in new tab so user can come back to app
                window.open(res.payment_url, "_blank");
                alertEl.textContent =
                  "Payment page opened in a new tab. Complete payment and then use Payment Status to verify using the transaction reference.";
                alertEl.className = "alert alert-success";
                alertEl.classList.remove("d-none");
              } else {
                throw new Error("Failed to initialize payment");
              }
            } catch (err) {
              const m = err.message || JSON.stringify(err);
              alertEl.textContent = m;
              alertEl.className = "alert alert-danger";
              alertEl.classList.remove("d-none");
            } finally {
              document.getElementById("startPaymentBtn").disabled = false;
            }
          });
      }
      function renderPaymentStatus() {
        document.getElementById("pageTitle").textContent = "Payment Status";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-receipt"></i> Payment Status</h3>
          <hr>
          <div id="verifyAlert" class="alert d-none"></div>
          <div class="mb-3">
            <label class="form-label">Transaction Reference</label>
            <input id="verifyRef" class="form-control" placeholder="Enter transaction reference" />
          </div>
          <button class="btn btn-primary" id="verifyRefBtn">Verify Payment</button>
          <div id="verifyResult" class="mt-3"></div>
        `;

        document
          .getElementById("verifyRefBtn")
          .addEventListener("click", async () => {
            const ref = document.getElementById("verifyRef").value.trim();
            const alertEl = document.getElementById("verifyAlert");
            alertEl.classList.add("d-none");
            if (!ref) {
              alertEl.textContent = "Enter a transaction reference to verify";
              alertEl.className = "alert alert-danger";
              alertEl.classList.remove("d-none");
              return;
            }
            try {
              document.getElementById("verifyRefBtn").disabled = true;
              const res = await apiRequest(
                `/payments/verify/${encodeURIComponent(ref)}`
              );
              document.getElementById(
                "verifyResult"
              ).innerHTML = `<pre>${JSON.stringify(res, null, 2)}</pre>`;
            } catch (err) {
              alertEl.textContent = err.message || String(err);
              alertEl.className = "alert alert-danger";
              alertEl.classList.remove("d-none");
            } finally {
              document.getElementById("verifyRefBtn").disabled = false;
            }
          });
      }
      function renderEvents() {
        document.getElementById("pageTitle").textContent = "School Events";
        document.getElementById(
          "contentArea"
        ).innerHTML = `<h3><i class="fas fa-calendar-alt"></i> School Events</h3><hr><div class="alert alert-info">Upcoming events will appear here.</div>`;
      }

      // helper UI functions: admin/student/parent interactions
      function showAddFeeModal() {
        const m = new bootstrap.Modal(document.getElementById("addFeeModal"));
        m.show();
      }

      function showAddEventModal() {
        const m = new bootstrap.Modal(document.getElementById("addEventModal"));
        m.show();
      }

      async function showChildProgressModal() {
        const modalEl = document.getElementById("childProgressModal");
        const m = new bootstrap.Modal(modalEl);
        const select = document.getElementById("childSelect");
        const content = document.getElementById("childProgressContent");
        select.innerHTML = `<option value="">Loading...</option>`;
        content.innerHTML = "Select a child to load progress.";
        try {
          // Try to fetch children for the parent
          const parentId = appState.user?.id;
          if (!parentId) throw new Error("Parent not available");
          const children = await apiRequest(
            `/students?parent_id=${encodeURIComponent(parentId)}`
          );
          if (!Array.isArray(children) || children.length === 0) {
            select.innerHTML = `<option value="">No children found</option>`;
          } else {
            select.innerHTML =
              `<option value="">Select a child</option>` +
              children
                .map(
                  (c) =>
                    `<option value="${c.id}">${
                      (c.first_name || "") + " " + (c.last_name || "")
                    } (${
                      c.admission_no || c.admissionNo || "ID:" + c.id
                    })</option>`
                )
                .join("");
            select.addEventListener("change", async function onChange() {
              const sid = this.value;
              if (!sid) return;
              await loadChildProgress(sid);
            });
          }
        } catch (err) {
          document.getElementById(
            "childProgressAlert"
          ).innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
        m.show();
      }

      async function loadChildProgress(studentId) {
        const content = document.getElementById("childProgressContent");
        content.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2 text-muted">Loading progress...</div></div>`;
        try {
          // Attempt common endpoints, fallback to raw student exams
          let res = null;
          try {
            res = await apiRequest(
              `/students/${encodeURIComponent(studentId)}/progress`
            );
          } catch (e) {}
          if (!res) {
            try {
              res = await apiRequest(
                `/students/${encodeURIComponent(studentId)}/exams`
              );
            } catch (e) {}
          }
          // fallback to grades endpoint if exams/progress not present
          if (!res) {
            try {
              res = await apiRequest(
                `/grades/student/${encodeURIComponent(studentId)}`
              );
            } catch (e) {}
          }
          if (!res) {
            content.innerHTML = `<div class="alert alert-info">No progress data available for this student.</div>`;
            return;
          }
          // If res includes exams/progress array, render table; otherwise pretty-print JSON
          if (Array.isArray(res) || (res.exams && Array.isArray(res.exams))) {
            const rows = (Array.isArray(res) ? res : res.exams)
              .map(
                (ev) =>
                  `<tr><td>${ev.name || ev.title || "Exam"}</td><td>${
                    ev.score != null ? ev.score : "-"
                  }</td><td>${ev.total_marks || ev.total || "-"}</td><td>${
                    ev.date ? new Date(ev.date).toLocaleDateString() : "-"
                  }</td></tr>`
              )
              .join("");
            content.innerHTML = `<div class="table-responsive"><table class="table"><thead><tr><th>Exam</th><th>Score</th><th>Total</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            return;
          }
          content.innerHTML = `<pre>${JSON.stringify(res, null, 2)}</pre>`;
        } catch (err) {
          content.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
      }

      async function showStudentProgress() {
        try {
          const sid = appState.user?.id;
          if (!sid) throw new Error("Student not available");
          const res = await apiRequest(
            `/students/${encodeURIComponent(sid)}/progress`
          );
          const content = document.getElementById("contentArea");
          if (Array.isArray(res) || (res.exams && Array.isArray(res.exams))) {
            const rows = (Array.isArray(res) ? res : res.exams)
              .map(
                (ev) =>
                  `<tr><td>${ev.name || ev.title || "Exam"}</td><td>${
                    ev.score != null ? ev.score : "-"
                  }</td><td>${ev.total_marks || ev.total || "-"}</td><td>${
                    ev.date ? new Date(ev.date).toLocaleDateString() : "-"
                  }</td></tr>`
              )
              .join("");
            content.innerHTML = `<h3><i class="fas fa-chart-line"></i> My Progress</h3><hr><div class="table-responsive"><table class="table"><thead><tr><th>Exam</th><th>Score</th><th>Total</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            return;
          }
          content.innerHTML = `<h3><i class="fas fa-chart-line"></i> My Progress</h3><hr><pre>${JSON.stringify(
            res,
            null,
            2
          )}</pre>`;
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
      }

      // wire admin modal submit handlers
      document
        .getElementById("addFeeForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const payload = {};
          for (const [k, v] of fd.entries())
            if (String(v).trim() !== "") payload[k] = v;
          try {
            await apiRequest("/fee-structures", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            document.getElementById("addFeeAlert").innerHTML =
              '<div class="alert alert-success">Fee structure created.</div>';
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addFeeModal")
            );
            if (modal) modal.hide();
            endpointHandlers["fee-structures"]?.();
          } catch (err) {
            document.getElementById(
              "addFeeAlert"
            ).innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
          }
        });

      document
        .getElementById("addEventForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const payload = {};
          // Build payload to match server EventCreate schema:
          // { title, description, event_type, start_date, end_date, location, organizer }
          const title = fd.get("title") || "";
          const dateVal = fd.get("date") || null;
          const details = fd.get("details") || "";
          if (!title || !dateVal) {
            document.getElementById(
              "addEventAlert"
            ).innerHTML = `<div class="alert alert-danger">Title and Date are required.</div>`;
            return;
          }

          const startISO = new Date(dateVal).toISOString();
          const payloadToSend = {
            title: title,
            description: details,
            event_type: "general", // default type for admin-created events
            start_date: startISO,
            end_date: startISO,
            location: fd.get("location") || null,
            organizer:
              (appState.user &&
                (appState.user.full_name || appState.user.email)) ||
              null,
          };

          try {
            await apiRequest("/events", {
              method: "POST",
              body: JSON.stringify(payloadToSend),
            });
            document.getElementById("addEventAlert").innerHTML =
              '<div class="alert alert-success">Event created.</div>';
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addEventModal")
            );
            if (modal) modal.hide();
            endpointHandlers["events"]?.();
          } catch (err) {
            document.getElementById(
              "addEventAlert"
            ).innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
          }
        });

      // sidebar header click
      document
        .querySelector(".sidebar-header")
        ?.addEventListener("click", () => {
          document
            .querySelectorAll(".menu-item")
            .forEach((i) => i.classList.remove("active"));
          const d = document.querySelector('[data-endpoint="dashboard"]');
          if (d) d.classList.add("active");
          endpointHandlers.dashboard();
        });

      // try restore user from storage
      try {
        const saved = JSON.parse(localStorage.getItem("currentUser") || "null");
        if (saved) {
          appState.user = saved;
          updateUserInfo();
          loadDashboardByRole(appState.user);
          showScreen("dashboardScreen");
        }
      } catch (e) {}

      // Note: add-teacher/student forms are rendered dynamically inside
      // renderAddTeacherForm / renderAddStudentForm so we don't attach
      // event listeners to non-existent DOM elements at load time.

      function renderClasses(data) {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-door-open"></i> Classes (${data.length})</h3>
          <hr>
          <div class="row">
            ${data
              .map(
                (cls) => `
              <div class="col-md-4 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">${cls.name}</h5>
                    <p class="card-text">
                      <strong>Level:</strong> ${cls.level || "N/A"}<br>
                      <strong>Section:</strong> ${cls.section || "N/A"}<br>
                      <strong>Students:</strong> ${cls.student_count || 0}
                    </p>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
      }

      function renderSubjects(data) {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-book"></i> Subjects (${data.length})</h3>
          <hr>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
        const html = data
          .map((s) =>
            <tr class="student-row" data-student-id="${s.id}"><td>${
          s.full_name || "N/A"
        }</td><td>${s.admission_no || s.registration_number || "N/A"}</td><td>${
          s.class_assigned || s.class_name || "N/A"
        }</td></tr>`.join("");

        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-users"></i> Students</h3>
            <div>
              <button class="btn btn-primary btn-sm" onclick="showAddStudentModal()"><i class="fas fa-plus"></i> Add Student</button>
            </div>
          </div>
          <div class="row">
            <div class="col-md-8">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light"><tr><th>Name</th><th>Admission/Reg No</th><th>Class</th></tr></thead>
                  <tbody id="studentsTableBody">${html}</tbody>
                </table>
              </div>
            </div>
            <div class="col-md-4">
              <div id="studentDetailSide" class="card p-3">
                <div class="text-center text-muted py-5">Select a student to view details</div>
              </div>
            </div>
          </div>
        `;

        // attach click handlers to rows
        document.querySelectorAll(".student-row").forEach((r) => {
          r.addEventListener("click", async () => {
            const id = r.getAttribute("data-student-id");
            if (!id) return;
            try {
              const res = await apiRequest(
                `/students/${encodeURIComponent(id)}/full`
              );
              if (res) renderAdminStudentFull(res);
            } catch (err) {
              renderError(err.message || String(err));
            }
          });
        });

        function renderAdminStudentFull(payload) {
          const student = payload.student || {};
          const user = payload.user || {};
          const clazz = payload.class || null;
          const grades = payload.grades || [];
          const attendances = payload.attendances || [];
          const fees = payload.fee_payments || [];

          const photo =
            resolvePhotoUrl(user.photo_url) ||
            `${API_BASE}/static/fair-educare/images/avatar-placeholder.png`;

          document.getElementById("studentDetailSide").innerHTML = `
          <div class="text-center mb-3">
            <img src="${photo}" alt="profile" style="width:110px;height:110px;border-radius:8px;object-fit:cover;" />
            <h5 class="mt-2">${
              user.full_name || student.first_name + " " + student.last_name
            }</h5>
            <p class="text-muted small">${user.email || ""}<br/>${
            user.phone || ""
          }</p>
            <div class="d-grid gap-2">
              <button class="btn btn-sm btn-outline-primary">Edit Profile</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="showMessageModal('${
                user.id || ""
              }')">Message</button>
            </div>
          </div>
          <hr>
          <div>
            <h6>Details</h6>
            <p><strong>Admission No:</strong> ${
              student.admission_no || "N/A"
            }</p>
            <p><strong>Class:</strong> ${clazz ? clazz.name : "N/A"}</p>
            <p><strong>DOB:</strong> ${student.dob || "N/A"}</p>
            <p><strong>Gender:</strong> ${student.gender || "N/A"}</p>
            <p><strong>Submissions:</strong> ${
              payload.submissions_count || 0
            }</p>
          </div>
          <hr>
          <div>
            <h6>Recent Grades</h6>
            <ul class="list-group mb-2">
              ${
                grades.length
                  ? grades
                      .slice(0, 5)
                      .map(
                        (g) =>
                          `<li class="list-group-item small"><strong>${
                            g.exam || "Exam"
                          }</strong>: ${g.marks_obtained} (${
                            g.grade_letter
                          })</li>`
                      )
                      .join("")
                  : '<li class="list-group-item small text-muted">No grades</li>'
              }
            </ul>
            <h6>Attendance (recent)</h6>
            <ul class="list-group mb-2">
              ${
                attendances.length
                  ? attendances
                      .slice(0, 5)
                      .map(
                        (a) =>
                          `<li class="list-group-item small">${new Date(
                            a.date
                          ).toLocaleDateString()} — ${a.status}</li>`
                      )
                      .join("")
                  : '<li class="list-group-item small text-muted">No attendance records</li>'
              }
            </ul>
            <h6>Payments</h6>
            <ul class="list-group">
              ${
                fees.length
                  ? fees
                      .slice(0, 5)
                      .map(
                        (f) =>
                          `<li class="list-group-item small">₦${
                            f.amount_paid
                          } — ${f.date || ""} — ${f.status || ""}</li>`
                      )
                      .join("")
                  : '<li class="list-group-item small text-muted">No payments</li>'
              }
            </ul>
          </div>
        `;
        }
        `;
      }

      // // --- Student & Teacher renderers (admin) ---
      // function renderStudents(data) {
      //   document.getElementById("pageTitle").textContent = "Students";
      //   const content = document.getElementById("contentArea");
      //   if (!data || data.length === 0) {
      //     content.innerHTML = `;
        //       <h3><i class="fas fa-users"></i> Students</h3>
        //       <hr>
        //       <div class="d-flex justify-content-between align-items-center mb-3">
        //         <div></div>
        //         <button class="btn btn-primary" onclick="renderAddStudentForm()"><i class="fas fa-user-plus"></i> Add Student</button>
        //       </div>
        //       <div class="alert alert-info"><i class="fas fa-info-circle"></i> No students found.</div>
        //     `;
        //     return;
        //   }

        content.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-users"></i> Students (${data.length})</h3>
            <button class="btn btn-primary" onclick="renderAddStudentForm()"><i class="fas fa-user-plus"></i> Add Student</button>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Admission No</th>
                  <th>Class ID</th>
                  <th>DOB</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${data
                  .map(
                    (s) => `
                      <tr>
                        <td>${
                          (s.first_name || "") + " " + (s.last_name || "")
                        }</td>
                        <td>${s.admission_no || s.admissionNumber || "-"}</td>
                        <td>${s.class_id || "-"}</td>
                        <td>${
                          s.dob ? new Date(s.dob).toLocaleDateString() : "-"
                        }</td>
                        <td>
                          <button class="btn btn-sm btn-secondary" onclick='alert("Implement edit/view")'>View</button>
                        </td>
                      </tr>
                    `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }

      function renderAddStudentForm() {
        document.getElementById("pageTitle").textContent = "Add Student";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-user-plus"></i> Add Student</h3>
          <hr>
          <div id="addStudentAlert"></div>
          <form id="addStudentForm">
            <div class="row">
              <div class="col-md-6 mb-3"><label class="form-label">First Name</label><input class="form-control" name="first_name" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Last Name</label><input class="form-control" name="last_name" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Student Email</label><input type="email" class="form-control" name="user_email" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Password</label><input type="password" class="form-control" name="user_password" placeholder="min 8 chars" required></div>
              <div class="col-md-4 mb-3"><label class="form-label">DOB</label><input type="date" class="form-control" name="dob"></div>
              <div class="col-md-4 mb-3"><label class="form-label">Gender</label><select class="form-select" name="gender"><option value="">Select</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
              <div class="col-md-4 mb-3"><label class="form-label">Admission No</label><input class="form-control" name="admission_no"></div>
              <div class="col-md-6 mb-3"><label class="form-label">Class ID</label><input class="form-control" name="class_id"></div>
              <div class="col-md-6 mb-3"><label class="form-label">Phone</label><input class="form-control" name="phone"></div>
              <div class="col-12"><button class="btn btn-primary">Create Student</button> <button type="button" class="btn btn-secondary ms-2" onclick="endpointHandlers.students()">Cancel</button></div>
            </div>
          </form>
        `;

        document
          .getElementById("addStudentForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {};
            for (const [k, v] of fd.entries())
              if (v !== null && String(v).trim() !== "") payload[k] = v;
            const alertDiv = document.getElementById("addStudentAlert");
            try {
              const created = await apiRequest("/students", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              const sid = created && created.id ? created.id : null;
              try {
                if (typeof showAlert === "function")
                  showAlert(
                    "loginAlert",
                    "Student created successfully",
                    "success"
                  );
              } catch (_) {}
              alertDiv.innerHTML = `<div class="alert alert-success d-flex justify-content-between align-items-center">
                <div><i class="fas fa-check-circle me-1"></i> Student created.</div>
                ${
                  sid
                    ? `<button type="button" class="btn btn-sm btn-outline-light" onclick="openStudentProfile('${sid}')"><i class='fas fa-user'></i> View Profile</button>`
                    : ""
                }
              </div>`;
              // Bump in-page Students header badge (triggers authoritative refresh)
              adjustCountBadge("studentsCountBadge", 1);
              // Refresh students list view without reloading the page
              endpointHandlers.students();
            } catch (err) {
              alertDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
          });
      }

      function renderTeachers(data) {
        document.getElementById("pageTitle").textContent = "Teachers";
        const content = document.getElementById("contentArea");
        if (!data || data.length === 0) {
          content.innerHTML = `
            <h3><i class="fas fa-chalkboard-teacher"></i> Teachers</h3>
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div></div>
              <button class="btn btn-primary" onclick="renderAddTeacherForm()"><i class="fas fa-user-plus"></i> Add Teacher</button>
            </div>
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> No teachers found.</div>
          `;
          return;
        }

        content.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-chalkboard-teacher"></i> Teachers (${
              data.length
            })</h3>
            <button class="btn btn-primary" onclick="renderAddTeacherForm()"><i class="fas fa-user-plus"></i> Add Teacher</button>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Employee ID</th>
                  <th>Qualification</th>
                  <th>Specialization</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${data
                  .map(
                    (t) => `
                      <tr>
                        <td>${
                          (t.first_name || "") + " " + (t.last_name || "")
                        }</td>
                        <td>${t.employee_id || "-"}</td>
                        <td>${t.qualification || "-"}</td>
                        <td>${t.specialization || "-"}</td>
                        <td><button class="btn btn-sm btn-secondary" onclick='alert("Implement edit/view")'>View</button></td>
                      </tr>
                    `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }

      function renderAddTeacherForm() {
        document.getElementById("pageTitle").textContent = "Add Teacher";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-user-plus"></i> Add Teacher</h3>
          <hr>
          <div id="addTeacherAlert"></div>
          <form id="addTeacherForm">
            <div class="row">
              <div class="col-md-6 mb-3"><label class="form-label">First Name</label><input class="form-control" name="first_name" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Last Name</label><input class="form-control" name="last_name" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">User Email</label><input type="email" class="form-control" name="user_email" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Password</label><input type="password" class="form-control" name="user_password" required placeholder="min 8 chars"></div>
              <div class="col-md-4 mb-3"><label class="form-label">Date of Birth</label><input type="date" class="form-control" name="date_of_birth" required></div>
              <div class="col-md-4 mb-3"><label class="form-label">Gender</label><select class="form-select" name="gender" required><option value="">Select</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
              <div class="col-md-4 mb-3"><label class="form-label">Employee ID</label><input class="form-control" name="employee_id" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Qualification</label><input class="form-control" name="qualification" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Specialization</label><input class="form-control" name="specialization"></div>
              <div class="col-md-4 mb-3"><label class="form-label">Experience Years</label><input type="number" class="form-control" name="experience_years" min="0"></div>
              <div class="col-md-4 mb-3"><label class="form-label">Joining Date</label><input type="date" class="form-control" name="joining_date" required></div>
              <div class="col-md-4 mb-3"><label class="form-label">Emergency Contact</label><input class="form-control" name="emergency_contact"></div>
              <div class="col-12 mb-3"><label class="form-label">Address</label><textarea class="form-control" name="address" rows="2"></textarea></div>
              <div class="col-12"><button class="btn btn-primary">Create Teacher</button> <button type="button" class="btn btn-secondary ms-2" onclick="endpointHandlers.teachers()">Cancel</button></div>
            </div>
          </form>
        `;

        document
          .getElementById("addTeacherForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {};
            for (const [k, v] of fd.entries())
              if (v !== null && String(v).trim() !== "") payload[k] = v;
            if (payload.experience_years)
              payload.experience_years = Number(payload.experience_years);
            const alertDiv = document.getElementById("addTeacherAlert");
            try {
              const created = await apiRequest("/teachers", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              alertDiv.innerHTML = `<div class="alert alert-success">Teacher created.</div>`;
              // Bump in-page Teachers header badge (triggers authoritative refresh)
              adjustCountBadge("teachersCountBadge", 1);
              // Refresh list
              endpointHandlers.teachers();
            } catch (err) {
              alertDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
          });
      }

      function renderExams(data) {
        if (data && data.length !== 0) {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-file-alt"></i> Exams (${data.length})</h3>
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Total Marks</th>
                    <th>Passing Marks</th>
                  </tr>
                </thead>
                <tbody>
                  ${data
                    .map(
                      (exam) => `
                    <tr>
                      <td>${exam.name || "N/A"}</td>
                      <td>${
                        exam.date
                          ? new Date(exam.date).toLocaleDateString()
                          : "N/A"
                      }</td>
                      <td>${exam.total_marks || 0}</td>
                      <td>${exam.passing_marks || 0}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
        } else {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-file-alt"></i> Exams</h3>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> No exams found.
            </div>
          `;
        }
      }

      function renderAddExamForm() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-plus-circle"></i> Add New Exam</h3>
          <hr>
          <div id="addExamAlert"></div>
          <form id="addExamForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Exam Name *</label>
                <input type="text" class="form-control" name="name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date *</label>
                <input type="date" class="form-control" name="date" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Total Marks *</label>
                <input type="number" class="form-control" name="total_marks" required min="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Passing Marks *</label>
                <input type="number" class="form-control" name="passing_marks" required min="0">
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="3"></textarea>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Create Exam
                </button>
                <button type="button" class="btn btn-secondary ms-2" onclick="endpointHandlers.exams()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
          </form>
        `;

        document
          .getElementById("addExamForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            for (let [key, value] of formData.entries()) {
              if (value.trim() !== "") {
                data[key] = value;
              }
            }

            const alertDiv = document.getElementById("addExamAlert");

            try {
              await apiRequest("/exams", {
                method: "POST",
                body: JSON.stringify(data),
              });
              alertDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                  <i class="fas fa-check-circle"></i> Exam created successfully!
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              e.target.reset();
            } catch (error) {
              alertDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                  <i class="fas fa-exclamation-circle"></i> Error: ${error.message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
            }
          });
      }

      function renderMarkAttendance() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-calendar-check"></i> Mark Attendance</h3>
          <hr>
          <div id="markAttendanceAlert"></div>
          <form id="markAttendanceForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Student ID *</label>
                <input type="text" class="form-control" name="student_id" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Class ID *</label>
                <input type="text" class="form-control" name="class_id" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date *</label>
                <input type="date" class="form-control" name="date" required value="${
                  new Date().toISOString().split("T")[0]
                }">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Status *</label>
                <select class="form-select" name="status" required>
                  <option value="present">Present</option>
                  <option value="absent">Absent</option>
                  <option value="late">Late</option>
                </select>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Remarks</label>
                <textarea class="form-control" name="remarks" rows="3"></textarea>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-check"></i> Mark Attendance
                </button>
              </div>
            </div>
          </form>
        `;

        document
          .getElementById("markAttendanceForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            for (let [key, value] of formData.entries()) {
              if (value.trim() !== "") {
                data[key] = value;
              }
            }

            const alertDiv = document.getElementById("markAttendanceAlert");

            try {
              await apiRequest("/attendance", {
                method: "POST",
                body: JSON.stringify(data),
              });
              alertDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                  <i class="fas fa-check-circle"></i> Attendance marked successfully!
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              e.target.reset();
              e.target.date.value = new Date().toISOString().split("T")[0];
            } catch (error) {
              alertDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                  <i class="fas fa-exclamation-circle"></i> Error: ${error.message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
            }
          });
      }

      function renderViewAttendance() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-eye"></i> View Attendance</h3>
          <hr>
          <form id="viewAttendanceForm" class="mb-4">
            <div class="row">
              <div class="col-md-8 mb-3">
                <label class="form-label">Student ID *</label>
                <input type="text" class="form-control" name="student_id" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-search"></i> Search
                </button>
              </div>
            </div>
          </form>
          <div id="attendanceResults"></div>
        `;

        document
          .getElementById("viewAttendanceForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const studentId = e.target.student_id.value.trim();
            const resultsDiv = document.getElementById("attendanceResults");

            resultsDiv.innerHTML = `
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading attendance records...</p>
              </div>
            `;

            try {
              const data = await apiRequest(`/attendance/student/${studentId}`);

              if (data && data.length !== 0) {
                resultsDiv.innerHTML = `
                  <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle"></i> Found ${
                      data.length
                    } attendance record(s)
                  </div>
                  <div class="table-responsive">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Status</th>
                          <th>Remarks</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${data
                          .map((record) => {
                            let dateStr = record.date || "N/A";
                            if (record.date) {
                              try {
                                dateStr = new Date(
                                  record.date
                                ).toLocaleDateString();
                              } catch (err) {
                                console.error("Date parse error:", err);
                              }
                            }

                            return `
                              <tr>
                                <td>${dateStr}</td>
                                <td>
                                  <span class="badge ${
                                    record.status === "present"
                                      ? "bg-success"
                                      : record.status === "absent"
                                      ? "bg-danger"
                                      : record.status === "late"
                                      ? "bg-warning"
                                      : "bg-secondary"
                                  }">
                                    ${record.status || "Unknown"}
                                  </span>
                                </td>
                                <td>${record.remarks || "-"}</td>
                              </tr>
                            `;
                          })
                          .join("")}
                      </tbody>
                    </table>
                  </div>
                `;
              } else {
                resultsDiv.innerHTML = `
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No attendance records found for this student.
                  </div>
                `;
              }
            } catch (error) {
              console.error("Attendance fetch error:", error);
              resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${error.message}
                  <br><small>Please check the Student ID and try again.</small>
                </div>
              `;
            }
          });
      }

      function renderFeeStructures(data) {
        if (data && data.length !== 0) {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-money-bill-wave"></i> Fee Structures (${
                data.length
              })</h3>
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Academic Year</th>
                    <th>Class</th>
                    <th>Amount</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  ${data
                    .map(
                      (fee) => `
                    <tr>
                      <td>${fee.academic_year || "N/A"}</td>
                      <td>${fee.class_id || "N/A"}</td>
                      <td><strong>₦${(
                        fee.amount || 0
                      ).toLocaleString()}</strong></td>
                      <td>${fee.description || "-"}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
        } else {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-money-bill-wave"></i> Fee Structures</h3>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> No fee structures found.
            </div>
          `;
        }
      }

      function renderFeePayments(data) {
        if (data && data.length !== 0) {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-credit-card"></i> Fee Payments (${
                data.length
              })</h3>
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Amount</th>
                    <th>Payment Date</th>
                    <th>Payment Method</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${data
                    .map(
                      (payment) => `
                    <tr>
                      <td>${
                        payment.student_name || payment.student_id || "N/A"
                      }</td>
                      <td><strong>₦${(
                        payment.amount || 0
                      ).toLocaleString()}</strong></td>
                      <td>${
                        payment.payment_date
                          ? new Date(payment.payment_date).toLocaleDateString()
                          : "N/A"
                      }</td>
                      <td>${payment.payment_method || "N/A"}</td>
                      <td>
                        <span class="badge ${
                          payment.status === "completed" ||
                          payment.status === "paid"
                            ? "bg-success"
                            : payment.status === "pending"
                            ? "bg-warning"
                            : "bg-danger"
                        }">
                          ${payment.status || "Unknown"}
                        </span>
                      </td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
        } else {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-credit-card"></i> Fee Payments</h3>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> No fee payments found.
            </div>
          `;
        }
      }

      function renderPayments(data, meta) {
        document.getElementById("pageTitle").textContent = "Payments";
        const content = document.getElementById("contentArea");
        const total = (meta && meta.total) || (data && data.length) || 0;
        if (!data || data.length === 0) {
          content.innerHTML = `
            <h3><i class="fas fa-wallet"></i> Payments</h3>
            <hr>
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> No payments found.</div>
          `;
          return;
        }

        content.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-wallet"></i> Payments (${total})</h3>
            <div>
              <button class="btn btn-sm btn-primary" id="refreshPaymentsBtn"><i class="fas fa-sync"></i> Refresh</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Parent Email</th>
                  <th>Amount (NGN)</th>
                  <th>Reference</th>
                  <th>Status</th>
                  <th>Method</th>
                  <th>Bank</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${data
                  .map(
                    (p) => `
                      <tr>
                        <td>${p.id}</td>
                        <td>${
                          p.parent_name || p.email || p.parent_id || "-"
                        }</td>
                        <td><strong>₦${(
                          p.amount || 0
                        ).toLocaleString()}</strong></td>
                        <td>${p.reference || "-"}</td>
                        <td><span class="badge ${
                          p.status === "paid"
                            ? "bg-success"
                            : p.status === "pending"
                            ? "bg-warning"
                            : "bg-danger"
                        }">${p.status || "-"}</span></td>
                        <td>${p.payment_method || "-"}</td>
                        <td>${p.bank || "-"}</td>
                        <td>${
                          p.transaction_date
                            ? new Date(p.transaction_date).toLocaleString()
                            : "-"
                        }</td>
                        <td>
                          <button class="btn btn-sm btn-outline-secondary me-1" onclick="showPaymentDetail(${
                            p.id
                          })">View</button>
                          <button class="btn btn-sm btn-outline-primary" data-ref="${
                            p.reference
                          }" onclick="verifyPaymentAsAdmin('${
                      p.reference
                    }', this)">Verify</button>
                        </td>
                      </tr>
                    `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;

        document
          .getElementById("refreshPaymentsBtn")
          .addEventListener("click", () => {
            endpointHandlers.payments();
          });
      }

      async function showPaymentDetail(paymentId) {
        if (!paymentId) return;
        try {
          const res = await apiRequest(`/payments/${paymentId}`);
          const content = document.getElementById("contentArea");
          content.innerHTML = `
            <h3><i class="fas fa-receipt"></i> Payment #${paymentId}</h3>
            <hr>
            <div class="mb-3"><button class="btn btn-sm btn-secondary" onclick="endpointHandlers.payments()">Back to list</button></div>
            <pre>${JSON.stringify(res, null, 2)}</pre>
          `;
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
      }

      async function verifyPaymentAsAdmin(ref, btn) {
        if (!ref) return;
        try {
          if (btn) btn.disabled = true;
          const res = await apiRequest(
            `/payments/verify/${encodeURIComponent(ref)}`
          );
          showAlert(
            "loginAlert",
            "Verify result: " + JSON.stringify(res),
            "success"
          );
          endpointHandlers.payments();
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      function renderPendingFees(data) {
        if (data && data.length !== 0) {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-exclamation-circle"></i> Pending Fees (${
                data.length
              })</h3>
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Class</th>
                    <th>Total Due</th>
                    <th>Total Paid</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>
                  ${data
                    .map(
                      (fee) => `
                    <tr>
                      <td>${fee.student_name || "N/A"}</td>
                      <td>${fee.class_id || "N/A"}</td>
                      <td>₦${(fee.total_due || 0).toLocaleString()}</td>
                      <td>₦${(fee.total_paid || 0).toLocaleString()}</td>
                      <td><strong style="color:var(--danger)">₦${(
                        fee.balance || 0
                      ).toLocaleString()}</strong></td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
        } else {
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3><i class="fas fa-exclamation-circle"></i> Pending Fees</h3>
            </div>
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> No pending fees found. All payments are up to date!
            </div>
          `;
        }
      }

      function renderRegisterForm() {
        document.getElementById("pageTitle").textContent = "Register New User";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-user-plus"></i> Register New User</h3>
          <hr>
          <div id="registerAlert"></div>
          <form id="registerForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name *</label>
                <input type="text" class="form-control" name="full_name" required placeholder="Enter full name">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" name="email" required placeholder="Enter email address">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Password *</label>
                <input type="password" class="form-control" name="password" required placeholder="Enter password" minlength="6">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" name="phone" placeholder="Enter phone number">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Role *</label>
                <select class="form-select" name="role" required>
                  <option value="">Select Role</option>
                  <option value="admin">Admin</option>
                  <option value="teacher">Teacher</option>
                  <option value="staff">Staff</option>
                  <option value="student">Student</option>
                  <option value="parent">Parent</option>
                </select>
              </div>
              <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-user-plus"></i> Register User
                </button>
                <button type="button" class="btn btn-secondary ms-2" onclick="endpointHandlers.dashboard()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
          </form>
        `;

        document
          .getElementById("registerForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            for (let [key, value] of formData.entries()) {
              if (value.trim() !== "") {
                data[key] = value;
              }
            }

            const alertDiv = document.getElementById("registerAlert");

            try {
              await apiRequest("/auth/register", {
                method: "POST",
                body: JSON.stringify(data),
              });
              alertDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                  <i class="fas fa-check-circle"></i> User registered successfully!
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              e.target.reset();
            } catch (error) {
              alertDiv.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show">
                      <i class="fas fa-exclamation-circle"></i> Error: ${error.message}
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                  `;
            }
          });
      }

      // Chart.js based bar chart helper and Store UI helpers
      let _classChartInstance = null;
      function drawBarChart(canvasId, labels, data) {
        // If Chart.js is available, use it; otherwise fallback to simple text
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        if (typeof Chart === "undefined") {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#666";
          ctx.fillText("Chart.js not loaded", 10, 20);
          return;
        }
        const ctx = canvas.getContext("2d");
        if (_classChartInstance) {
          try {
            _classChartInstance.destroy();
          } catch (e) {}
          _classChartInstance = null;
        }
        _classChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Students",
                data: data,
                backgroundColor: labels.map(() => "rgba(79,70,229,0.8)"),
                borderColor: labels.map(() => "rgba(79,70,229,1)"),
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function renderStoreCatalog(items) {
        document.getElementById("pageTitle").textContent = "School Store";
        const html = `<div class="row">${items
          .map(
            (it) =>
              `<div class="col-md-4 mb-3"><div class="card"><img src="${
                it.image_url || "/static/fair-educare/img/placeholder.png"
              }" class="card-img-top" style="height:160px;object-fit:cover"/><div class="card-body text-center"><h6>${
                it.title
              }</h6><p class="mb-1">NGN ${
                it.price
              }</p><button class="btn btn-sm btn-primary" onclick="addToCart('${
                it.id
              }')">Add to cart</button></div></div></div>`
          )
          .join("")}</div>`;
        document.getElementById("contentArea").innerHTML =
          html +
          `<div class="mt-3"><button class="btn btn-success" onclick="endpointHandlers['view-cart']()">View Cart</button></div>`;
      }

      async function addToCart(itemId) {
        try {
          await apiRequest("/store/cart", {
            method: "POST",
            body: JSON.stringify({ item_id: itemId, qty: 1 }),
          });
          showAlert("loginAlert", "Item added to cart", "success");
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
      }

      function renderCart(items) {
        document.getElementById("pageTitle").textContent = "My Store Cart";
        if (!items || items.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">Your cart is empty.</div>`;
          return;
        }
        const rows = items
          .map(
            (it) =>
              `<tr><td>${it.title}</td><td>${it.qty}</td><td>NGN ${
                it.price
              }</td><td>NGN ${it.qty * it.price}</td></tr>`
          )
          .join("");
        document.getElementById(
          "contentArea"
        ).innerHTML = `<h3>My Cart</h3><div class="table-responsive"><table class="table"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr></thead><tbody>${rows}</tbody></table></div><div class="text-end"><button class="btn btn-primary" onclick="checkoutCart()">Checkout</button></div>`;
      }

      async function checkoutCart() {
        try {
          const res = await apiRequest("/store/checkout", { method: "POST" });
          showAlert(
            "loginAlert",
            `Checkout complete. Total: NGN ${res.total}`,
            "success"
          );
          endpointHandlers.dashboard();
        } catch (err) {
          showAlert("loginAlert", err.message || String(err), "danger");
        }
      }

      function renderBirthdays(list) {
        document.getElementById("pageTitle").textContent = "Upcoming Birthdays";
        if (!list || list.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">No birthdays in the next 30 days.</div>`;
          return;
        }
        const items = list
          .map(
            (b) =>
              `<li class="list-group-item"><strong>${
                b.name
              }</strong> <span class="text-muted">(${
                b.type
              })</span> — ${new Date(b.date).toLocaleDateString()}</li>`
          )
          .join("");
        document.getElementById(
          "contentArea"
        ).innerHTML = `<h3>Upcoming Birthdays</h3><ul class="list-group mt-3">${items}</ul>`;
      }

      // News Feed with Birthdays renderer
      function renderNewsFeedWithBirthdays(birthdays) {
        document.getElementById("pageTitle").textContent =
          "News Feed & Birthdays";
        const birthdaysList =
          birthdays && birthdays.length > 0
            ? birthdays
                .map(
                  (b) =>
                    `<div class="card mb-2"><div class="card-body"><i class="fas fa-birthday-cake text-warning"></i> <strong>${
                      b.name
                    }</strong>'s birthday on ${new Date(
                      b.date
                    ).toLocaleDateString()}</div></div>`
                )
                .join("")
            : '<div class="alert alert-info">No upcoming birthdays.</div>';

        const isAdmin = (appState.user?.role || "").toLowerCase() === "admin";
        const pendingSection = isAdmin
          ? '<div id="pendingMessages" class="mb-3"></div>'
          : "";

        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-newspaper"></i> News Feed</h3>
            <button class="btn btn-primary" onclick="showPostMessageModal()"><i class="fas fa-plus"></i> Post Message</button>
          </div>
          <div class="row">
            <div class="col-md-8">
              ${pendingSection}
              <div id="publicMessagesList" class="vstack gap-2 mb-3"></div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header bg-warning text-dark"><i class="fas fa-birthday-cake"></i> Upcoming Birthdays</div>
                <div class="card-body" style="max-height:400px;overflow-y:auto;">
                  ${birthdaysList}
                </div>
              </div>
            </div>
          </div>
        `;

        // load approved messages
        (async () => {
          try {
            const msgs = await apiRequest("/messages");
            const list = document.getElementById("publicMessagesList");
            list.innerHTML =
              (msgs || [])
                .map((m) => {
                  const u = m.user || {};
                  const photo =
                    resolvePhotoUrl(u.photo_url) ||
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(
                      u.full_name || "User"
                    )}&background=6366f1&color=fff&size=64`;
                  const dt = m.created_at
                    ? new Date(m.created_at).toLocaleString()
                    : "";
                  return `
                <div class="card">
                  <div class="card-body d-flex">
                    <img src="${photo}" alt="avatar" class="rounded-circle me-3" width="48" height="48"/>
                    <div>
                      <div class="fw-semibold">${
                        u.full_name || "User"
                      } <small class="text-muted">${dt}</small></div>
                      <div>${m.content || ""}</div>
                    </div>
                  </div>
                </div>`;
                })
                .join("") || '<div class="text-muted">No messages yet.</div>';
          } catch (e) {
            const list = document.getElementById("publicMessagesList");
            if (list)
              list.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          }
        })();

        // load pending messages if admin
        if (isAdmin) {
          loadPendingMessages();
        }
      }

      // ADMIN Renderers
      function renderAdminSMS() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-sms"></i> SMS/WhatsApp Management</h3>
          <hr>
          <div class="card">
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <label class="form-label">Recipient Group</label>
                  <select class="form-select">
                    <option>All Students</option>
                    <option>All Parents</option>
                    <option>All Teachers</option>
                    <option>Class-specific</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Message</label>
                  <textarea class="form-control" rows="4" placeholder="Type your message..."></textarea>
                </div>
                <button type="button" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send SMS</button>
                <button type="button" class="btn btn-success ms-2"><i class="fab fa-whatsapp"></i> Send WhatsApp</button>
              </form>
            </div>
          </div>
        `;
      }

      function renderAdminMailbox() {
        document.getElementById("pageTitle").textContent = "Mailbox";
        document.getElementById("contentArea").innerHTML = `
          <div id="mailboxRoot">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="mb-0"><i class="fas fa-envelope"></i> Mailbox</h3>
              <div class="btn-group" role="group" aria-label="Mailbox tabs">
                <button id="btnInboxTab" class="btn btn-sm btn-outline-primary active"><i class="fas fa-inbox"></i> Inbox <span id="unreadBadge" class="badge bg-danger ms-1">0</span></button>
                <button id="btnSentTab" class="btn btn-sm btn-outline-secondary"><i class="fas fa-paper-plane"></i> Sent</button>
              </div>
            </div>
            <div class="card mb-3">
              <div class="card-body">
                <form id="composeForm">
                  <input type="hidden" name="thread_id" id="composeThread" />
                  <div class="row g-2 align-items-center">
                    <div class="col-md-4"><input class="form-control" name="recipient_email" placeholder="To (email)" required></div>
                    <div class="col-md-5"><input class="form-control" name="subject" placeholder="Subject" required></div>
                    <div class="col-md-3 text-end"><button class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button></div>
                    <div class="col-12 mt-2"><textarea class="form-control" rows="3" name="body" placeholder="Write your message..." required></textarea></div>
                  </div>
                </form>
                <div id="composeStatus" class="small mt-2 text-muted"></div>
              </div>
            </div>
            <div id="mailboxStatus" class="alert alert-info d-none"></div>
            <div class="card">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width:28%">From</th>
                      <th>Subject</th>
                      <th style="width:22%">Date</th>
                      <th style="width:90px">Action</th>
                    </tr>
                  </thead>
                  <tbody id="mailboxTableBody">
                    <tr><td colspan="4" class="text-center text-muted py-3">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card mt-3 d-none" id="mailView">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 id="mailSubject" class="mb-0"></h5>
                  <div>
                    <button class="btn btn-sm btn-outline-primary me-1" id="replyBtn"><i class="fas fa-reply"></i> Reply</button>
                    <button class="btn btn-sm btn-outline-secondary me-1" id="forwardBtn"><i class="fas fa-share"></i> Forward</button>
                    <button class="btn btn-sm btn-secondary" id="closeMailView"><i class="fas fa-times"></i> Close</button>
                  </div>
                </div>
                <div class="text-muted small mb-2"><span id="mailFrom"></span> • <span id="mailDate"></span></div>
                <div id="mailBody" style="white-space:pre-wrap"></div>
                <hr/>
                <div id="mailThread">
                  <div class="text-muted small">Conversation</div>
                  <div id="mailThreadList" class="mt-2"></div>
                </div>
              </div>
            </div>
          </div>
        `;

        // Polling management scoped to mailbox view
        if (appState.mailTimer) {
          try {
            clearInterval(appState.mailTimer);
          } catch (_) {}
          appState.mailTimer = null;
        }

        let activeTab = "inbox"; // or 'sent'

        async function loadInbox(unreadOnly = false) {
          const tBody = document.getElementById("mailboxTableBody");
          const status = document.getElementById("mailboxStatus");
          try {
            const rows = await apiRequest(
              `/mail/inbox?unread_only=${unreadOnly}`
            );
            const unread = (rows || []).filter((r) => !r.is_read).length;
            const badge = document.getElementById("unreadBadge");
            if (badge) badge.textContent = String(unread);
            if (!rows || rows.length === 0) {
              tBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">No messages</td></tr>`;
            } else {
              tBody.innerHTML = rows
                .map((r) => {
                  const dt = r.created_at
                    ? new Date(r.created_at).toLocaleString()
                    : "";
                  const bold = r.is_read ? "" : "fw-semibold";
                  return `<tr>
                  <td class="${bold}">${r.sender_email}</td>
                  <td class="${bold}">${r.subject || "(no subject)"}</td>
                  <td>${dt}</td>
                  <td><button class="btn btn-sm btn-outline-primary" data-view-id="${
                    r.id
                  }"><i class="fas fa-eye"></i></button></td>
                </tr>`;
                })
                .join("");
            }
            status.classList.add("d-none");
          } catch (e) {
            status.textContent = e.message || String(e);
            status.classList.remove("d-none");
          }
        }

        async function loadSent() {
          const tBody = document.getElementById("mailboxTableBody");
          const status = document.getElementById("mailboxStatus");
          try {
            const rows = await apiRequest(`/mail/sent`);
            if (!rows || rows.length === 0) {
              tBody.innerHTML = `<tr><td colspan=\"4\" class=\"text-center text-muted py-3\">No sent messages</td></tr>`;
            } else {
              tBody.innerHTML = rows
                .map((r) => {
                  const dt = r.created_at
                    ? new Date(r.created_at).toLocaleString()
                    : "";
                  return `<tr>
                  <td>${appState.user?.email || "Me"}</td>
                  <td>${r.subject || "(no subject)"}</td>
                  <td>${dt}</td>
                  <td><button class="btn btn-sm btn-outline-primary" data-view-id="${
                    r.id
                  }"><i class="fas fa-eye"></i></button></td>
                </tr>`;
                })
                .join("");
            }
            status.classList.add("d-none");
          } catch (e) {
            status.textContent = e.message || String(e);
            status.classList.remove("d-none");
          }
        }

        async function openMessage(id) {
          const view = document.getElementById("mailView");
          const subj = document.getElementById("mailSubject");
          const from = document.getElementById("mailFrom");
          const when = document.getElementById("mailDate");
          const body = document.getElementById("mailBody");
          try {
            const msg = await apiRequest(`/mail/${encodeURIComponent(id)}`);
            subj.textContent = msg.subject || "(no subject)";
            from.textContent = `From: ${msg.sender_email}`;
            when.textContent = msg.created_at
              ? new Date(msg.created_at).toLocaleString()
              : "";
            body.textContent = msg.body || "";
            view.classList.remove("d-none");
            // Load thread messages
            (async () => {
              try {
                const threadKey = msg.thread_id || msg.id;
                const listEl = document.getElementById("mailThreadList");
                if (listEl)
                  listEl.innerHTML =
                    '<div class="text-muted small">Loading conversation...</div>';
                // Fetch inbox and sent summaries, then filter to thread
                const [inboxRows, sentRows] = await Promise.all([
                  apiRequest(`/mail/inbox?unread_only=false`),
                  apiRequest(`/mail/sent`),
                ]);
                const summaries = [...(inboxRows || []), ...(sentRows || [])];
                const related = summaries.filter(
                  (r) => (r.thread_id || r.id) === threadKey
                );
                // Ensure the currently opened message is included
                if (!related.find((r) => r.id === msg.id))
                  related.push({ id: msg.id, created_at: msg.created_at });
                // Sort by time ascending
                related.sort(
                  (a, b) =>
                    new Date(a.created_at || 0) - new Date(b.created_at || 0)
                );
                // Fetch full bodies
                const fullMsgs = [];
                for (const r of related) {
                  try {
                    fullMsgs.push(
                      await apiRequest(`/mail/${encodeURIComponent(r.id)}`)
                    );
                  } catch (_) {}
                }
                if (listEl) {
                  listEl.innerHTML =
                    (fullMsgs || [])
                      .map((m) => {
                        const me = (appState.user?.email || "").toLowerCase();
                        const byMe =
                          (m.sender_email || "").toLowerCase() === me;
                        const dt = m.created_at
                          ? new Date(m.created_at).toLocaleString()
                          : "";
                        return `<div class="border rounded p-2 mb-2 ${
                          byMe ? "bg-light" : ""
                        }"><div class="small text-muted">${
                          byMe ? "Me" : m.sender_email
                        } • ${dt}</div><div style="white-space:pre-wrap">${(
                          m.body || ""
                        ).replace(
                          /[&<>]/g,
                          (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])
                        )}</div></div>`;
                      })
                      .join("") ||
                    '<div class="text-muted small">No conversation history</div>';
                }
                // Wire reply/forward buttons
                const replyBtn = document.getElementById("replyBtn");
                const fwdBtn = document.getElementById("forwardBtn");
                if (replyBtn)
                  replyBtn.onclick = () => {
                    const subjLine = (msg.subject || "").startsWith("Re:")
                      ? msg.subject
                      : `Re: ${msg.subject || ""}`;
                    const quote = `\n\nOn ${new Date(
                      msg.created_at
                    ).toLocaleString()}, ${msg.sender_email} wrote:\n${
                      msg.body || ""
                    }`;
                    const thread = msg.thread_id || msg.id;
                    prefillCompose(msg.sender_email, subjLine, quote, thread);
                  };
                if (fwdBtn)
                  fwdBtn.onclick = () => {
                    const subjLine = (msg.subject || "").startsWith("Fwd:")
                      ? msg.subject
                      : `Fwd: ${msg.subject || ""}`;
                    const quote = `\n\n---------- Forwarded message ---------\nFrom: ${
                      msg.sender_email
                    }\nDate: ${new Date(
                      msg.created_at
                    ).toLocaleString()}\nSubject: ${msg.subject || ""}\n\n${
                      msg.body || ""
                    }`;
                    const thread = msg.thread_id || msg.id;
                    prefillCompose("", subjLine, quote, thread);
                  };
              } catch (_) {}
            })();
            // Mark read if we are the recipient
            if (
              msg.recipient_email &&
              msg.recipient_email === appState.user?.email &&
              !msg.is_read
            ) {
              try {
                await apiRequest(`/mail/${encodeURIComponent(id)}/read`, {
                  method: "POST",
                });
              } catch (_) {}
              // Refresh inbox counts
              if (activeTab === "inbox") loadInbox(false);
            }
          } catch (e) {
            showAlert("loginAlert", e.message || String(e));
          }
        }

        // Wire up events
        document.getElementById("btnInboxTab").addEventListener("click", () => {
          activeTab = "inbox";
          document.getElementById("btnInboxTab").classList.add("active");
          document.getElementById("btnSentTab").classList.remove("active");
          loadInbox(false);
        });
        document.getElementById("btnSentTab").addEventListener("click", () => {
          activeTab = "sent";
          document.getElementById("btnSentTab").classList.add("active");
          document.getElementById("btnInboxTab").classList.remove("active");
          loadSent();
        });
        document
          .getElementById("closeMailView")
          .addEventListener("click", () => {
            document.getElementById("mailView").classList.add("d-none");
          });
        // Delegate click for view buttons
        document
          .getElementById("contentArea")
          .addEventListener("click", (e) => {
            const btn = e.target.closest("[data-view-id]");
            if (btn) openMessage(btn.getAttribute("data-view-id"));
          });

        // Compose form submit handler
        document
          .getElementById("composeForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {
              recipient_email: String(fd.get("recipient_email") || "").trim(),
              subject: String(fd.get("subject") || "").trim(),
              body: String(fd.get("body") || "").trim(),
            };
            const thread = String(fd.get("thread_id") || "").trim();
            if (thread) payload.thread_id = thread;
            const status = document.getElementById("composeStatus");
            status.textContent = "Sending...";
            try {
              await apiRequest("/mail/send", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              status.textContent = "Sent ✓";
              e.target.reset();
              // Clear thread binding after send
              const th = document.getElementById("composeThread");
              if (th) th.value = "";
              // Switch to Sent tab and refresh
              document.getElementById("btnSentTab").click();
            } catch (err) {
              status.textContent = err.message || String(err);
            }
          });

        // Prefill compose utility
        function prefillCompose(recipient, subject, body, threadId) {
          const form = document.getElementById("composeForm");
          if (!form) return;
          form.recipient_email.value = recipient || "";
          form.subject.value = subject || "";
          form.body.value = body || "";
          const th = document.getElementById("composeThread");
          if (th) th.value = threadId || "";
          form.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        // Initial load
        loadInbox(false);
        // Start polling unread count while view exists
        appState.mailTimer = setInterval(() => {
          if (!document.getElementById("mailboxRoot")) {
            clearInterval(appState.mailTimer);
            appState.mailTimer = null;
            return;
          }
          // Only refresh inbox (unread) for badge
          (async () => {
            try {
              const rows = await apiRequest(`/mail/inbox?unread_only=true`);
              const unread = (rows || []).filter((r) => !r.is_read).length;
              const badge = document.getElementById("unreadBadge");
              if (badge) badge.textContent = String(unread);
            } catch (_) {}
          })();
        }, 10000);
      }

      function renderAdminNewsFeed() {
        document.getElementById("pageTitle").textContent = "News Feed";
        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-newspaper"></i> News Feed</h3>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="loadPendingMessages()" title="Pending messages"><i class="fas fa-hourglass-half"></i></button>
              <button class="btn btn-primary" onclick="showPostMessageModal()"><i class="fas fa-plus"></i> Post Message</button>
            </div>
          </div>
          <div id="pendingMessages" class="mb-3"></div>
          <div id="messagesList" class="vstack gap-2"></div>
        `;
        (async () => {
          try {
            const msgs = await apiRequest("/messages");
            const list = document.getElementById("messagesList");
            list.innerHTML =
              (msgs || [])
                .map((m) => {
                  const u = m.user || {};
                  const photo =
                    resolvePhotoUrl(u.photo_url) ||
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(
                      u.full_name || "User"
                    )}&background=6366f1&color=fff&size=64`;
                  const dt = m.created_at
                    ? new Date(m.created_at).toLocaleString()
                    : "";
                  return `
                <div class="card">
                  <div class="card-body d-flex">
                    <img src="${photo}" alt="avatar" class="rounded-circle me-3" width="48" height="48"/>
                    <div>
                      <div class="fw-semibold">${
                        u.full_name || "User"
                      } <small class="text-muted">${dt}</small></div>
                      <div>${m.content || ""}</div>
                    </div>
                  </div>
                </div>`;
                })
                .join("") || '<div class="text-muted">No messages yet.</div>';
            // If user is admin, load pending messages area
            if ((appState.user?.role || "").toLowerCase() === "admin")
              loadPendingMessages();
          } catch (e) {
            renderError("Failed to load messages");
          }
        })();
      }

      function renderAdminPendingMessages() {
        document.getElementById("pageTitle").textContent = "Pending Messages";
        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-clock"></i> Pending Messages</h3>
            <button class="btn btn-outline-secondary" onclick="loadPendingMessagesForAdminPage()"><i class="fas fa-refresh"></i> Refresh</button>
          </div>
          <div id="pendingMessagesList" class="vstack gap-2"></div>
        `;
        loadPendingMessagesForAdminPage();
      }

      function loadPendingMessagesForAdminPage() {
        const container = document.getElementById("pendingMessagesList");
        if (!container) return;
        container.innerHTML =
          '<div class="text-center py-4"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">Loading pending messages...</div></div>';
        (async () => {
          try {
            // Allow a saved admin override token to be used when current user is not admin
            const adminOverride = localStorage.getItem("adminOverrideToken");
            if (
              (appState.user?.role || "").toLowerCase() !== "admin" &&
              !adminOverride
            ) {
              container.innerHTML = `<div class="alert alert-warning">Admin access required to view pending messages. <button class="btn btn-sm btn-primary" onclick="promptAdminToken()">Use admin token</button></div>`;
              return;
            }
            const headers = adminOverride
              ? { Authorization: `Bearer ${adminOverride}` }
              : undefined;
            const pending = await apiRequest("/messages/pending", { headers });
            if (!pending || !pending.length) {
              container.innerHTML =
                '<div class="alert alert-info">No pending messages.</div>';
              return;
            }
            container.innerHTML = pending
              .map((m) => {
                const u = m.user || {};
                const photo =
                  resolvePhotoUrl(u.photo_url) ||
                  `https://ui-avatars.com/api/?name=${encodeURIComponent(
                    u.full_name || "User"
                  )}&background=6366f1&color=fff&size=64`;
                const dt = m.created_at
                  ? new Date(m.created_at).toLocaleString()
                  : "";
                return `
                <div class="card">
                  <div class="card-body d-flex">
                    <img src="${photo}" alt="avatar" class="rounded-circle me-3" width="48" height="48"/>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">${
                        u.full_name || "User"
                      } <small class="text-muted">${dt}</small></div>
                      <div>${m.content || ""}</div>
                    </div>
                    <div class="ms-2 text-end">
                      <button class="btn btn-sm btn-success mb-1" onclick="approveMessage('${
                        m.id
                      }')">Approve</button><br/>
                      <button class="btn btn-sm btn-danger" onclick="removeMessage('${
                        m.id
                      }')">Delete</button>
                    </div>
                  </div>
                </div>`;
              })
              .join("");
          } catch (e) {
            container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          }
        })();
      }

      function renderAdminEClassroom() {
        document.getElementById("pageTitle").textContent = "E-Classroom";
        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-video"></i> E-Classroom</h3>
            <button class="btn btn-primary" onclick="showCreateClassroomModal()"><i class="fas fa-plus"></i> Create Classroom</button>
          </div>
          <div class="row g-3" id="classroomsList">
            <div class="col-12 text-muted">Loading classrooms...</div>
          </div>
        `;
        loadVirtualClassrooms();
      }

      function renderAdminLessonPlanner() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-calendar-day"></i> Lesson Planner</h3>
          <hr>
          <button class="btn btn-primary mb-3"><i class="fas fa-plus"></i> Create Lesson</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Date</th><th>Class</th><th>Subject</th><th>Topic</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center text-muted py-3">No lessons planned</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderAdminAssignments() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-tasks"></i> Assignments Management</h3>
          <hr>
          <button class="btn btn-primary mb-3"><i class="fas fa-plus"></i> Create Assignment</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Class</th><th>Subject</th><th>Title</th><th>Due Date</th><th>Submissions</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center text-muted py-3">No assignments</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderAdminCBT() {
        document.getElementById("pageTitle").textContent = "CBT";
        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-laptop"></i> CBT</h3>
            <button class="btn btn-primary" onclick="showCreateCBTModal()"><i class="fas fa-plus"></i> Create CBT</button>
          </div>
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header bg-info text-white">Active Tests</div>
                <div class="card-body">
                  <div class="text-muted">No active CBT tests at the moment.</div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header bg-success text-white">Completed Tests</div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped mb-0">
                      <thead class="table-light"><tr><th>User</th><th>Test ID</th><th>Score</th><th>Time</th><th>Date</th></tr></thead>
                      <tbody id="completedTestsBody">
                        <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        loadCompletedCBTs();
      }

      // Admin helpers: News Feed, E-Classroom, CBT
      function showPostMessageModal() {
        let modalEl = document.getElementById("postMessageModal");
        if (!modalEl) {
          const wrapper = document.createElement("div");
          wrapper.innerHTML = `
            <div class="modal fade" id="postMessageModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Post Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div id="postMsgAlert"></div>
                    <textarea id="postMsgContent" class="form-control" rows="4" placeholder="What's new?"></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="postMsgBtn">Post</button>
                  </div>
                </div>
              </div>
            </div>`;
          document.body.appendChild(wrapper.firstElementChild);
          modalEl = document.getElementById("postMessageModal");
        }
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        const btn = document.getElementById("postMsgBtn");
        btn.onclick = async () => {
          const content = (
            document.getElementById("postMsgContent").value || ""
          ).trim();
          const alertDiv = document.getElementById("postMsgAlert");
          alertDiv.innerHTML = "";
          if (!content) {
            alertDiv.innerHTML =
              '<div class="alert alert-warning">Enter a message.</div>';
            return;
          }
          try {
            const response = await apiRequest("/messages", {
              method: "POST",
              body: JSON.stringify({ content }),
            });
            modal.hide();
            if (response.approved) {
              showAlert(
                "loginAlert",
                "Message posted successfully!",
                "success"
              );
            } else {
              showAlert(
                "loginAlert",
                "Your message has been sent to pending messages for admin approval. Please wait while it is reviewed.",
                "info"
              );
            }
            // Reload the current view
            if (
              typeof renderAdminNewsFeed === "function" &&
              (appState.user?.role || "").toLowerCase() === "admin"
            ) {
              renderAdminNewsFeed();
            } else if (typeof renderNewsFeedWithBirthdays === "function") {
              renderNewsFeedWithBirthdays();
            }
          } catch (e) {
            alertDiv.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          }
        };
      }

      async function loadPendingMessages() {
        const container = document.getElementById("pendingMessages");
        if (!container) return;
        container.innerHTML =
          '<div class="text-muted">Loading pending messages...</div>';
        try {
          const adminOverride = localStorage.getItem("adminOverrideToken");
          if (
            (appState.user?.role || "").toLowerCase() !== "admin" &&
            !adminOverride
          ) {
            container.innerHTML = "";
            return;
          }
          const headers = adminOverride
            ? { Authorization: `Bearer ${adminOverride}` }
            : undefined;
          const pending = await apiRequest("/messages/pending", { headers });
          if (!pending || !pending.length) {
            container.innerHTML = "";
            return;
          }
          container.innerHTML = `<div class="card mb-3"><div class="card-body"><h6 class="mb-2">Pending Messages</h6>${pending
            .map((m) => {
              const u = m.user || {};
              const photo =
                resolvePhotoUrl(u.photo_url) ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(
                  u.full_name || "User"
                )}&background=6366f1&color=fff&size=48`;
              const dt = m.created_at
                ? new Date(m.created_at).toLocaleString()
                : "";
              return `<div class="d-flex align-items-start mb-2"><img src="${photo}" class="rounded-circle me-2" width="40" height="40"/><div class="flex-grow-1"><div class="fw-semibold">${
                u.full_name || "User"
              } <small class="text-muted">${dt}</small></div><div>${
                m.content
              }</div></div><div class="ms-2 text-end"><button class="btn btn-sm btn-success mb-1" onclick="approveMessage('${
                m.id
              }')">Approve</button><br/><button class="btn btn-sm btn-danger" onclick="removeMessage('${
                m.id
              }')">Delete</button></div></div>`;
            })
            .join("")}</div></div>`;
        } catch (e) {
          container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
        }
      }

      async function approveMessage(id) {
        try {
          const adminOverride = localStorage.getItem("adminOverrideToken");
          const opts = { method: "POST" };
          if (adminOverride)
            opts.headers = { Authorization: `Bearer ${adminOverride}` };
          await apiRequest(`/messages/${encodeURIComponent(id)}/approve`, opts);
          showAlert("loginAlert", "Message approved", "success");
          renderAdminNewsFeed();
        } catch (e) {
          showAlert("loginAlert", e.message || String(e));
        }
      }

      async function removeMessage(id) {
        if (!confirm("Delete this message?")) return;
        try {
          const adminOverride = localStorage.getItem("adminOverrideToken");
          const opts = { method: "DELETE" };
          if (adminOverride)
            opts.headers = { Authorization: `Bearer ${adminOverride}` };
          await apiRequest(`/messages/${encodeURIComponent(id)}`, opts);
          showAlert("loginAlert", "Message deleted", "success");
          renderAdminNewsFeed();
        } catch (e) {
          showAlert("loginAlert", e.message || String(e));
        }
      }

      async function loadVirtualClassrooms() {
        const container = document.getElementById("classroomsList");
        try {
          const res = await apiRequest("/classrooms");
          const list = Array.isArray(res) ? res : res.items || [];
          if (!list.length) {
            container.innerHTML =
              '<div class="col-12 text-muted">No classrooms yet.</div>';
            return;
          }
          container.innerHTML = list
            .map(
              (c) => `
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="card-title mb-0">${c.name || "Classroom"}</h6>
                    <span class="badge bg-primary">${
                      c.platform || "Link"
                    }</span>
                  </div>
                  <div class="small text-muted mb-2">Created by: ${
                    c.created_by_name || c.created_by || ""
                  }</div>
                  <a class="btn btn-sm btn-outline-primary" target="_blank" href="${
                    c.platform_link || "#"
                  }"><i class="fas fa-external-link"></i> Join</a>
                </div>
              </div>
            </div>`
            )
            .join("");
        } catch (e) {
          container.innerHTML = `<div class="col-12 text-danger">${e.message}</div>`;
        }
      }

      function showCreateClassroomModal() {
        let modalEl = document.getElementById("createClassroomModal");
        if (!modalEl) {
          const wrapper = document.createElement("div");
          wrapper.innerHTML = `
            <div class="modal fade" id="createClassroomModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Create Classroom</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div id="createClassAlert"></div>
                    <div class="mb-3"><label class="form-label">Class Name</label><input id="vcName" class="form-control" placeholder="e.g. Grade 1A Mathematics"></div>
                    <div class="mb-3"><label class="form-label">Platform</label>
                      <select id="vcPlatform" class="form-select">
                        <option value="Zoom">Zoom</option>
                        <option value="Google Meet">Google Meet</option>
                        <option value="Microsoft Teams">Microsoft Teams</option>
                      </select>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createClassBtn">Create</button>
                  </div>
                </div>
              </div>
            </div>`;
          document.body.appendChild(wrapper.firstElementChild);
          modalEl = document.getElementById("createClassroomModal");
        }
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        document.getElementById("createClassBtn").onclick = async () => {
          const name = (document.getElementById("vcName").value || "").trim();
          const platform = document.getElementById("vcPlatform").value;
          const alertDiv = document.getElementById("createClassAlert");
          alertDiv.innerHTML = "";
          if (!name) {
            alertDiv.innerHTML =
              '<div class="alert alert-warning">Enter a class name.</div>';
            return;
          }
          try {
            await apiRequest("/classrooms", {
              method: "POST",
              body: JSON.stringify({ name, platform }),
            });
            modal.hide();
            loadVirtualClassrooms();
          } catch (e) {
            alertDiv.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          }
        };
      }

      async function loadCompletedCBTs() {
        const tbody = document.getElementById("completedTestsBody");
        if (!tbody) return;
        try {
          const res = await apiRequest("/cbt/completed");
          const list = Array.isArray(res) ? res : res.items || [];
          tbody.innerHTML =
            list
              .map(
                (r) => `
            <tr>
              <td>${r.user?.full_name || r.user_name || "User"}</td>
              <td>${r.test_id || "-"}</td>
              <td>${r.score != null ? r.score : "-"}</td>
              <td>${r.time_taken || "-"}</td>
              <td>${
                r.created_at ? new Date(r.created_at).toLocaleString() : ""
              }</td>
            </tr>
          `
              )
              .join("") ||
            '<tr><td colspan="5" class="text-center text-muted">No submissions</td></tr>';
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-danger">${e.message}</td></tr>`;
        }
      }

      // Called by dashboard.html window via window.opener
      window.recordCBTCompletion = async function (submission) {
        try {
          await apiRequest("/cbt/submit", {
            method: "POST",
            body: JSON.stringify(submission),
          });
          showAlert(
            "loginAlert",
            `CBT submitted successfully for ${submission.test_id}.`,
            "success"
          );
          loadCompletedCBTs();
        } catch (e) {
          showAlert("loginAlert", e.message || "Failed to record CBT");
        }
      };

      function showCreateCBTModal() {
        let modalEl = document.getElementById("createCBTModal");
        if (!modalEl) {
          const wrapper = document.createElement("div");
          wrapper.innerHTML = `
            <div class="modal fade" id="createCBTModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header"><h5 class="modal-title">Create/Start CBT</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                  <div class="modal-body">
                    <p>This demo opens the CBT interface in a new window.</p>
                    <div class="mb-3"><label class="form-label">Test ID</label><input id="cbtTestId" class="form-control" placeholder="e.g. MATH-101"/></div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="startCBTBtn"><i class="fas fa-play"></i> Start CBT</button>
                  </div>
                </div>
              </div>
            </div>`;
          document.body.appendChild(wrapper.firstElementChild);
          modalEl = document.getElementById("createCBTModal");
        }
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        document.getElementById("startCBTBtn").onclick = () => {
          const testId = (
            document.getElementById("cbtTestId").value || "DEMO-TEST"
          ).trim();
          const url = `/dashboard.html?testId=${encodeURIComponent(testId)}`;
          window.open(url, "CBTWindow", "width=1024,height=768");
          modal.hide();
        };
      }

      function renderAdminClasses(data) {
        document.getElementById("pageTitle").textContent = "Classes Management";
        if (!data || data.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">No classes found.</div>`;
          return;
        }
        const html = data
          .map(
            (c) =>
              `<tr><td>${c.name || "N/A"}</td><td>${
                c.form_name || "N/A"
              }</td><td>${c.class_teacher || "N/A"}</td></tr>`
          )
          .join("");
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-door-open"></i> Classes</h3>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Class</button>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-light"><tr><th>Name</th><th>Form</th><th>Teacher</th></tr></thead>
              <tbody>${html}</tbody>
            </table>
          </div>
        `;
      }

      function renderAdminSubjects(data) {
        document.getElementById("pageTitle").textContent =
          "Subjects Management";
        if (!data || data.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">No subjects found.</div>`;
          return;
        }
        const html = data
          .map(
            (s) =>
              `<tr><td>${s.name || "N/A"}</td><td>${s.code || "N/A"}</td></tr>`
          )
          .join("");
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-book"></i> Subjects</h3>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Subject</button>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-light"><tr><th>Name</th><th>Code</th></tr></thead>
              <tbody>${html}</tbody>
            </table>
          </div>
        `;
      }

      function renderAdminExams(data) {
        document.getElementById("pageTitle").textContent = "Exams Management";
        if (!data || data.length === 0) {
          document.getElementById(
            "contentArea"
          ).innerHTML = `<div class="alert alert-info">No exams found.</div>`;
          return;
        }
        const html = data
          .map(
            (e) =>
              `<tr><td>${e.name || "N/A"}</td><td>${
                e.date ? new Date(e.date).toLocaleDateString() : "N/A"
              }</td><td>${e.total_marks || 0}</td></tr>`
          )
          .join("");
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-file-alt"></i> Exams</h3>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Exam</button>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-light"><tr><th>Name</th><th>Date</th><th>Total Marks</th></tr></thead>
              <tbody>${html}</tbody>
            </table>
          </div>
        `;
      }

      function renderAdminHR() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-users-cog"></i> HR Management</h3>
          <hr>
          <div class="row">
            <div class="col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-users fa-2x text-primary mb-3"></i>
                  <h6>Total Staff</h6>
                  <p class="h4">-</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-calendar-check fa-2x text-success mb-3"></i>
                  <h6>On Leave</h6>
                  <p class="h4">-</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-check-circle fa-2x text-info mb-3"></i>
                  <h6>Present</h6>
                  <p class="h4">-</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-file-alt fa-2x text-warning mb-3"></i>
                  <h6>Pending Tasks</h6>
                  <p class="h4">-</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminTeachers(data) {
        document.getElementById("pageTitle").textContent =
          "Teachers Management";
        const count = (data || []).length;
        const html = (data || [])
          .map((t) => {
            const id = t?.id || "";
            return `<tr data-teacher-id="${id}"><td>${
              t.full_name || "N/A"
            }</td><td>${
              t.email || "N/A"
            }</td><td><span class="badge bg-primary">${
              t.department || "N/A"
            }</span></td><td>
              <button class="btn btn-sm btn-outline-secondary me-1" data-edit-teacher-id="${id}" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" data-del-teacher-id="${id}" title="Delete"><i class="fas fa-trash"></i></button>
            </td></tr>`;
          })
          .join("");
        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-chalkboard-teacher"></i> Teachers <span id="teachersCountBadge" class="badge bg-primary ms-2">${count}</span></h3>
            <button class="btn btn-primary btn-sm" onclick="renderAddTeacherForm()"><i class="fas fa-user-plus"></i> Add Teacher</button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-light"><tr><th>Name</th><th>Email</th><th>Department</th><th style="width:110px">Actions</th></tr></thead>
              <tbody id="teachersTableBody">${
                html ||
                '<tr><td colspan="4" class="text-center text-muted">No teachers found.</td></tr>'
              }</tbody>
            </table>
          </div>
        `;
      }

      function renderAdminParents() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-user-tie"></i> Parents Management</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Parent</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Name</th><th>Email</th><th>Phone</th><th>Children</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No parents registered</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderAdminStudents(data) {
        document.getElementById("pageTitle").textContent = "Students";
        const listHtml = (data || [])
          .map(
            (s) => `
          <tr class="student-row" data-student-id="${s.id}">
            <td>${
              s.full_name ||
              (s.first_name || "") + " " + (s.last_name || "") ||
              "N/A"
            }</td>
            <td>${s.registration_number || s.admission_no || "N/A"}</td>
            <td>${s.class_assigned || s.class_name || s.class_id || "N/A"}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary me-1" data-edit-student-id="${
                s.id
              }" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" data-del-student-id="${
                s.id
              }" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `
          )
          .join("");

        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-users"></i> Students <span id="studentsCountBadge" class="badge bg-primary ms-2">${
              (data || []).length
            }</span></h3>
            <button class="btn btn-primary btn-sm" onclick="renderAddStudentForm()"><i class="fas fa-user-plus"></i> Add Student</button>
          </div>
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped mb-0">
                      <thead class="table-light"><tr><th>Name</th><th>Reg. No</th><th>Class</th><th style=\"width:110px\">Actions</th></tr></thead>
                      <tbody id="studentsTableBody">${
                        listHtml ||
                        '<tr><td colspan="4" class="text-center text-muted">No students</td></tr>'
                      }</tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div id="studentDetailSide" class="card p-3">
                <div class="text-center text-muted py-5">Select a student to view details</div>
              </div>
            </div>
          </div>
        `;

        document.querySelectorAll(".student-row").forEach((r) => {
          r.addEventListener("click", async () => {
            const id = r.getAttribute("data-student-id");
            if (!id) return;
            const side = document.getElementById("studentDetailSide");
            side.innerHTML =
              '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            try {
              const payload = await apiRequest(
                `/students/${encodeURIComponent(id)}/full`
              );
              const student = payload.student || {};
              const user = payload.user || {};
              const clazz = payload.class || null;
              const grades = payload.grades || [];
              const photo =
                resolvePhotoUrl(user.photo_url) ||
                `${API_BASE}/static/fair-educare/images/avatar-placeholder.png`;
              side.innerHTML = `
                <div class="text-center mb-3">
                  <img src="${photo}" alt="profile" style="width:110px;height:110px;border-radius:8px;object-fit:cover;" />
                  <h5 class="mt-2">${
                    user.full_name ||
                    (student.first_name || "") + " " + (student.last_name || "")
                  }</h5>
                  <p class="text-muted small">${user.email || ""}<br/>${
                user.phone || ""
              }</p>
                </div>
                <div class="mb-3">
                  <h6>Details</h6>
                  <div class="small"><strong>Admission No:</strong> ${
                    student.admission_no || "N/A"
                  }</div>
                  <div class="small"><strong>Class:</strong> ${
                    clazz ? clazz.name : student.class_id || "N/A"
                  }</div>
                  <div class="small"><strong>DOB:</strong> ${
                    student.dob || "N/A"
                  }</div>
                  <div class="small"><strong>Gender:</strong> ${
                    student.gender || "N/A"
                  }</div>
                </div>
                <div>
                  <h6>Recent Grades</h6>
                  <ul class="list-group mb-2">
                    ${
                      (grades || [])
                        .slice(0, 5)
                        .map(
                          (g) =>
                            `<li class="list-group-item small"><strong>${
                              g.exam || "Exam"
                            }</strong>: ${g.marks_obtained ?? "-"} ${
                              g.grade_letter ? `(${g.grade_letter})` : ""
                            }</li>`
                        )
                        .join("") ||
                      '<li class="list-group-item small text-muted">No grades</li>'
                    }
                  </ul>
                </div>`;
            } catch (e) {
              side.innerHTML = `<div class=\"alert alert-danger\">${e.message}</div>`;
            }
          });
        });
      }

      function renderAdminMedicals() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-heart"></i> Medical Records</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Medical Record</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Student</th><th>Condition</th><th>Date</th><th>Action</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No medical records</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderAdminTalentPool() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-star"></i> Talent Pool</h3>
          <hr>
          <div class="row">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <i class="fas fa-music fa-2x text-primary mb-2"></i>
                  <h6>Music Talents</h6>
                  <p class="text-muted">0 Students</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <i class="fas fa-futbol fa-2x text-success mb-2"></i>
                  <h6>Sports Talents</h6>
                  <p class="text-muted">0 Students</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <i class="fas fa-palette fa-2x text-warning mb-2"></i>
                  <h6>Arts Talents</h6>
                  <p class="text-muted">0 Students</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <i class="fas fa-robot fa-2x text-info mb-2"></i>
                  <h6>STEM Talents</h6>
                  <p class="text-muted">0 Students</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminVisitorMgmt() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-user-check"></i> Visitor Management</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Register Visitor</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Name</th><th>Purpose</th><th>Check-in</th><th>Check-out</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center text-muted py-3">No visitors logged</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderAdminFacilities() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-building"></i> Facility Management</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Facility</button>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-header bg-primary text-white">Classrooms</div>
                <div class="card-body text-center">
                  <h4 class="text-primary">-</h4>
                  <small class="text-muted">Total</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-header bg-success text-white">Labs</div>
                <div class="card-body text-center">
                  <h4 class="text-success">-</h4>
                  <small class="text-muted">Total</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-header bg-warning text-dark">Sports Grounds</div>
                <div class="card-body text-center">
                  <h4 class="text-warning">-</h4>
                  <small class="text-muted">Total</small>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminPhotoJournals() {
        document.getElementById("pageTitle").textContent = "Photo Journals";
        document.getElementById("contentArea").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-images"></i> Photo Journals</h3>
          </div>
          <div id="albumAlert" class="alert d-none"></div>
          <div class="card mb-3">
            <div class="card-body">
              <form id="albumUploadForm">
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label">Album Title</label>
                    <input name="title" class="form-control" placeholder="e.g. Inter-House Sports 2025" required />
                  </div>
                  <div class="col-md-7">
                    <label class="form-label">Description (optional)</label>
                    <input name="description" class="form-control" placeholder="Short description" />
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Photos</label>
                    <input id="albumFiles" type="file" class="form-control" accept="image/*" multiple required />
                  </div>
                </div>
                <div class="mt-3">
                  <button class="btn btn-primary"><i class="fas fa-upload"></i> Upload Album</button>
                </div>
              </form>
            </div>
          </div>
          <div class="row" id="albumGrid"><div class="col-12 text-center text-muted py-4">Loading albums...</div></div>
        `;

        document
          .getElementById("albumUploadForm")
          ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const alertEl = document.getElementById("albumAlert");
            alertEl.classList.add("d-none");
            const title = e.target.querySelector('[name="title"]').value.trim();
            const description = e.target
              .querySelector('[name="description"]')
              .value.trim();
            const files = document.getElementById("albumFiles").files;
            if (!title || !files || files.length === 0) {
              alertEl.className = "alert alert-danger";
              alertEl.textContent =
                "Please provide a title and select at least one image.";
              alertEl.classList.remove("d-none");
              return;
            }
            try {
              const fd = new FormData();
              fd.append("title", title);
              if (description) fd.append("description", description);
              for (const f of files) fd.append("images", f);
              const res = await apiRequest("/photo-journals/albums", {
                method: "POST",
                body: fd,
              });
              alertEl.className = "alert alert-success";
              alertEl.textContent = `Album "${res.title}" uploaded with ${
                res.photos?.length || 0
              } photos.`;
              alertEl.classList.remove("d-none");
              e.target.reset();
              await loadAlbums();
            } catch (err) {
              alertEl.className = "alert alert-danger";
              alertEl.textContent = err.message || String(err);
              alertEl.classList.remove("d-none");
            }
          });

        loadAlbums();
      }

      async function loadAlbums() {
        try {
          const res = await apiRequest("/photo-journals/albums");
          renderAlbumGrid(res.albums || []);
        } catch (e) {
          renderAlbumGrid([]);
        }
      }

      function renderAlbumGrid(albums) {
        const grid = document.getElementById("albumGrid");
        if (!albums || albums.length === 0) {
          grid.innerHTML =
            '<div class="col-12 text-center text-muted py-4">No photo albums created yet.</div>';
          return;
        }
        grid.innerHTML = albums
          .map(
            (a) => `
            <div class="col-md-3 mb-3">
              <div class="card h-100" role="button" onclick="showAlbumDetail('${
                a.id
              }')">
                <img src="${resolvePhotoUrl(
                  a.cover_url
                )}" alt="cover" class="card-img-top" style="height:160px;object-fit:cover;" />
                <div class="card-body">
                  <h6 class="card-title mb-1">${a.title}</h6>
                  <div class="small text-muted">${
                    a.photo_count || 0
                  } photos</div>
                </div>
              </div>
            </div>`
          )
          .join("");
      }

      async function showAlbumDetail(id) {
        try {
          const a = await apiRequest(
            `/photo-journals/albums/${encodeURIComponent(id)}`
          );
          document.getElementById("contentArea").innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="mb-0"><i class="fas fa-images"></i> ${a.title}</h3>
              <button class="btn btn-sm btn-outline-secondary" onclick="renderAdminPhotoJournals()"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="row">
              ${(a.photos || [])
                .map(
                  (p) => `
                    <div class="col-md-3 mb-3">
                      <div class="card h-100">
                        <img src="${resolvePhotoUrl(
                          p.image_url
                        )}" class="card-img-top" style="height:200px;object-fit:cover;" />
                      </div>
                    </div>`
                )
                .join("")}
            </div>`;
        } catch (e) {
          showAlert("loginAlert", e.message || String(e));
        }
      }

      // Simple wrapper so both admin and non-admin views can reuse the same renderer
      function renderStudents(data) {
        renderAdminStudents(data);
      }

      function renderAdminAttendance(data) {
        document.getElementById("pageTitle").textContent =
          "Attendance Management";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-calendar-check"></i> Attendance Management</h3>
          <hr>
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Select Class</label>
              <select class="form-select"><option>All Classes</option></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Select Date</label>
              <input type="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label>&nbsp;</label>
              <button class="btn btn-primary w-100"><i class="fas fa-search"></i> Search</button>
            </div>
          </div>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Student</th><th>Present</th><th>Absent</th><th>Late</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">Select filters to view attendance</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderAdminReports(data) {
        document.getElementById("pageTitle").textContent =
          "Reports & Analytics";
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-chart-bar"></i> Reports & Analytics</h3>
          <hr>
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-chart-line fa-2x text-primary mb-3"></i>
                  <h6>Student Performance</h6>
                  <button class="btn btn-sm btn-outline-primary">View Report</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-graduation-cap fa-2x text-success mb-3"></i>
                  <h6>Class Distribution</h6>
                  <button class="btn btn-sm btn-outline-success" onclick="endpointHandlers['class-distribution']()">View Chart</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-money-bill-wave fa-2x text-warning mb-3"></i>
                  <h6>Finance Reports</h6>
                  <button class="btn btn-sm btn-outline-warning">View Report</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminClubs() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-users-circle"></i> Clubs & Societies</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Create Club</button>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Debate Club</h6>
                  <p class="card-text text-muted small">Members: 15</p>
                  <button class="btn btn-sm btn-outline-primary">Manage</button>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Science Club</h6>
                  <p class="card-text text-muted small">Members: 22</p>
                  <button class="btn btn-sm btn-outline-primary">Manage</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminRevenues(data) {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-money-bill-wave"></i> Weekly Revenues</h3>
          <hr>
          <div class="row">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="text-muted">This Week</h6>
                  <h3 class="text-primary">₦-</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="text-muted">This Month</h6>
                  <h3 class="text-success">₦-</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="text-muted">This Year</h6>
                  <h3 class="text-info">₦-</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="text-muted">Outstanding</h6>
                  <h3 class="text-warning">₦-</h3>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // TEACHER Renderers
      function renderTeacherEClassroom() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-video"></i> E-Classroom</h3>
          <hr>
          <div class="alert alert-info"><i class="fas fa-info-circle"></i> E-classroom sessions will appear here.</div>
          <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Start Session</button>
        `;
      }

      function renderTeacherLessonPlanner() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-calendar-day"></i> Lesson Planner</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Create Lesson</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Date</th><th>Class</th><th>Subject</th><th>Topic</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No lessons planned</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderTeacherAssignments() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-tasks"></i> My Assignments</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Create Assignment</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Class</th><th>Title</th><th>Due Date</th><th>Submissions</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No assignments</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderTeacherSubjects() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-book"></i> My Subjects</h3>
          <hr>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-header bg-primary text-white">Subject</div>
                <div class="card-body">
                  <h6>English Language</h6>
                  <p class="text-muted small">Classes: 1A, 1B, 1C</p>
                  <button class="btn btn-sm btn-outline-primary">View Students</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderTeacherCBT() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-laptop"></i> CBT</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Create CBT</button>
          <div class="card">
            <div class="card-body text-center text-muted py-5">
              <i class="fas fa-laptop fa-3x mb-3"></i>
              <p>No CBT created yet.</p>
            </div>
          </div>
        `;
      }

      function renderTeacherTimetable() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-clock"></i> My Timetable</h3>
          <hr>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr><th>Time</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th><th>Friday</th></tr>
              </thead>
              <tbody>
                <tr><td>9:00-10:00</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
                <tr><td>10:00-11:00</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
                <tr><td>11:00-12:00</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
              </tbody>
            </table>
          </div>
        `;
      }

      function renderTeacherSecondaryReport() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-chart-line"></i> Secondary School Report</h3>
          <hr>
          <form class="card p-3 mb-3">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Select Class</label>
                <select class="form-select"><option>Class 1A</option></select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Term</label>
                <select class="form-select"><option>Term 1</option><option>Term 2</option><option>Term 3</option></select>
              </div>
            </div>
            <button type="button" class="btn btn-primary">Generate Report</button>
          </form>
        `;
      }

      function renderTeacherBehaviourTracker() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-list-check"></i> Behaviour Tracker</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Log Behaviour</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Student</th><th>Date</th><th>Behaviour</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No records</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderTeacherPastoral() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-handshake"></i> Pastoral Care</h3>
          <hr>
          <div class="alert alert-info"><i class="fas fa-heart"></i> Log pastoral care interactions with your students.</div>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Add Entry</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Student</th><th>Date</th><th>Notes</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="3" class="text-center text-muted py-3">No entries yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderTeacherHRM() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-users-cog"></i> HRM Information</h3>
          <hr>
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header bg-primary text-white">Employment Info</div>
                <div class="card-body">
                  <p><strong>Department:</strong> -</p>
                  <p><strong>Employment Date:</strong> -</p>
                  <p><strong>Position:</strong> -</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header bg-success text-white">Leave Balance</div>
                <div class="card-body">
                  <p><strong>Annual Leave:</strong> - days</p>
                  <p><strong>Sick Leave:</strong> - days</p>
                  <p><strong>Used Leave:</strong> - days</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderTeacherFeedback() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-comments"></i> Feedback & Ratings</h3>
          <hr>
          <div class="alert alert-info"><i class="fas fa-star"></i> View feedback from students and parents.</div>
          <div class="card">
            <div class="card-body text-center text-muted py-5">
              <i class="fas fa-comments fa-3x mb-3"></i>
              <p>No feedback received yet.</p>
            </div>
          </div>
        `;
      }

      // STUDENT Renderers
      function renderStudentRateTeacher() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-star"></i> Rate My Teacher</h3>
          <hr>
          <form class="card p-3">
            <div class="mb-3">
              <label class="form-label">Select Teacher</label>
              <select class="form-select"><option>Select a teacher...</option></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Rating (1-5 stars)</label>
              <div class="star-rating">
                <i class="fas fa-star" data-rating="1"></i>
                <i class="fas fa-star" data-rating="2"></i>
                <i class="fas fa-star" data-rating="3"></i>
                <i class="fas fa-star" data-rating="4"></i>
                <i class="fas fa-star" data-rating="5"></i>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comments</label>
              <textarea class="form-control" rows="3" placeholder="Share your thoughts..."></textarea>
            </div>
            <button type="button" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Rating</button>
          </form>
        `;
      }

      function renderStudentSubjects() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-book"></i> My Subjects</h3>
          <hr>
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header bg-primary text-white">Mathematics</div>
                <div class="card-body">
                  <p><strong>Teacher:</strong> -</p>
                  <p><strong>Last Assignment:</strong> -</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header bg-success text-white">English Language</div>
                <div class="card-body">
                  <p><strong>Teacher:</strong> -</p>
                  <p><strong>Last Assignment:</strong> -</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderStudentScores() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-chart-line"></i> My Scores</h3>
          <hr>
          <div class="alert alert-info"><i class="fas fa-info-circle"></i> View your scores and grades.</div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-light">
                <tr><th>Subject</th><th>Exam</th><th>Score</th><th>Grade</th></tr>
              </thead>
              <tbody>
                <tr><td colspan="4" class="text-center text-muted py-3">No scores yet</td></tr>
              </tbody>
            </table>
          </div>
        `;
      }

      function renderStudentCBT() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-laptop"></i> CBT (Computer Based Tests)</h3>
          <hr>
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header bg-primary text-white">Available Tests</div>
                <div class="card-body text-center text-muted py-3">
                  <p>No tests available at the moment.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header bg-success text-white">Completed Tests</div>
                <div class="card-body text-center text-muted py-3">
                  <p>No completed tests.</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // PARENT Renderers
      function renderParentWallet() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-wallet"></i> My Wallet</h3>
          <hr>
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <h6 class="text-muted">Wallet Balance</h6>
                  <h2 class="text-success">₦-</h2>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <h6 class="text-muted">Total Spent</h6>
                  <h2 class="text-danger">₦-</h2>
                </div>
              </div>
            </div>
          </div>
          <button class="btn btn-primary"><i class="fas fa-plus"></i> Add Funds</button>
        `;
      }

      function renderParentFees() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-receipt"></i> School Fees</h3>
          <hr>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-light">
                <tr><th>Child</th><th>Term</th><th>Amount</th><th>Status</th><th>Action</th></tr>
              </thead>
              <tbody>
                <tr><td colspan="5" class="text-center text-muted py-3">No fees found</td></tr>
              </tbody>
            </table>
          </div>
        `;
      }

      function renderParentBills() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-file-invoice"></i> Bills & Invoices</h3>
          <hr>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Description</th><th>Amount</th><th>Date</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No bills</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderParentStore(items) {
        document.getElementById("pageTitle").textContent = "School Store";
        let storeHTML = `
          <h3><i class="fas fa-shopping-cart"></i> School Store</h3>
          <hr>
          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" class="form-control" placeholder="Search store items...">
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-outline-primary" onclick="endpointHandlers['parent-store']()"><i class="fas fa-refresh"></i> Refresh</button>
              <button class="btn btn-success"><i class="fas fa-shopping-cart"></i> View Cart</button>
            </div>
          </div>
          <div class="row">
        `;

        if (!items || items.length === 0) {
          storeHTML +=
            '<div class="col-12"><div class="alert alert-info">No items available in the store.</div></div>';
        } else {
          items.forEach((item) => {
            storeHTML += `
              <div class="col-md-4 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title">${item.name || "Item"}</h6>
                    <p class="card-text text-muted">${
                      item.description || "No description"
                    }</p>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                      <span class="h5 mb-0">₦${item.price || 0}</span>
                      <button class="btn btn-sm btn-primary" onclick="addToCart(${
                        item.id
                      })"><i class="fas fa-cart-plus"></i></button>
                    </div>
                    <small class="text-muted d-block mt-2">Stock: ${
                      item.stock || 0
                    }</small>
                  </div>
                </div>
              </div>
            `;
          });
        }
        storeHTML += "</div>";
        document.getElementById("contentArea").innerHTML = storeHTML;
      }

      function renderParentStoreAppointments() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-calendar-check"></i> Store Appointments</h3>
          <hr>
          <button class="btn btn-primary btn-sm mb-3"><i class="fas fa-plus"></i> Book Appointment</button>
          <div class="card">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>Date</th><th>Time</th><th>Purpose</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted py-3">No appointments booked</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderParentFeedback() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-comments"></i> Send Feedback</h3>
          <hr>
          <form class="card p-3">
            <div class="mb-3">
              <label class="form-label">Feedback Type</label>
              <select class="form-select">
                <option>General Feedback</option>
                <option>Complaint</option>
                <option>Suggestion</option>
                <option>Compliment</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Message</label>
              <textarea class="form-control" rows="4" placeholder="Share your feedback..."></textarea>
            </div>
            <button type="button" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
          </form>
        `;
      }

      function renderParentPastoral() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-handshake"></i> Pastoral Care</h3>
          <hr>
          <div class="alert alert-info"><i class="fas fa-info-circle"></i> Pastoral care updates from the school will appear here.</div>
          <div class="card">
            <div class="card-body text-center text-muted py-5">
              <i class="fas fa-handshake fa-3x mb-3"></i>
              <p>No pastoral updates yet.</p>
            </div>
          </div>
        `;
      }

      function renderParentFinance() {
        document.getElementById("contentArea").innerHTML = `
          <h3><i class="fas fa-chart-pie"></i> Finance Dashboard</h3>
          <hr>
          <div class="row mb-3">
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total Due</h6>
                  <h3 class="text-danger">₦-</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total Paid</h6>
                  <h3 class="text-success">₦-</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h6 class="text-muted">Outstanding</h6>
                  <h3 class="text-warning">₦-</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h6 class="text-muted">Balance</h6>
                  <h3 class="text-info">₦-</h3>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderError(message) {
        document.getElementById("contentArea").innerHTML = `
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
              `;
      }

      // Helpers to navigate to a newly created student's profile
      async function waitForElement(selector, timeout = 5000) {
        const start = Date.now();
        return new Promise((resolve, reject) => {
          const check = () => {
            const el = document.querySelector(selector);
            if (el) return resolve(el);
            if (Date.now() - start >= timeout)
              return reject(new Error("Element not found: " + selector));
            setTimeout(check, 50);
          };
          check();
        });
      }

      async function openStudentProfile(studentId) {
        try {
          await endpointHandlers.students();
          const row = await waitForElement(
            `[data-student-id="${studentId}"]`,
            5000
          );
          row.scrollIntoView({ behavior: "smooth", block: "center" });
          row.click();
        } catch (e) {
          try {
            await endpointHandlers.students();
          } catch (_) {}
        }
      }

      // Global delegated delete handlers for Students/Teachers
      (function wireGlobalDeleteHandlers() {
        const area = document.getElementById("contentArea");
        if (!area) return;
        area.addEventListener("click", async (e) => {
          // Edit handlers
          const editBtn = e.target.closest(
            "[data-edit-student-id], [data-edit-teacher-id]"
          );
          if (editBtn) {
            e.preventDefault();
            e.stopPropagation();
            const sid = editBtn.getAttribute("data-edit-student-id");
            const tid = editBtn.getAttribute("data-edit-teacher-id");
            if (sid) return openEditStudentModal(sid);
            if (tid) return openEditTeacherModal(tid);
          }
          // Delete handlers
          const btn = e.target.closest(
            "[data-del-student-id], [data-del-teacher-id]"
          );
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          const studentId = btn.getAttribute("data-del-student-id");
          const teacherId = btn.getAttribute("data-del-teacher-id");
          const isStudent = !!studentId;
          const id = studentId || teacherId;
          const entity = isStudent ? "student" : "teacher";
          if (!id) return;
          if (
            !confirm(
              `Are you sure you want to delete this ${entity}? This cannot be undone.`
            )
          )
            return;
          btn.disabled = true;
          try {
            await apiRequest(
              `/${isStudent ? "students" : "teachers"}/${encodeURIComponent(
                id
              )}`,
              {
                method: "DELETE",
              }
            );
            try {
              showAlert(
                "loginAlert",
                `${entity.charAt(0).toUpperCase() + entity.slice(1)} deleted`,
                "success"
              );
            } catch (_) {}
            // Decrement badge (adjustCountBadge will refresh dashboard KPIs)
            adjustCountBadge(
              isStudent ? "studentsCountBadge" : "teachersCountBadge",
              -1
            );
            // Refresh current admin list view
            if (isStudent && endpointHandlers["admin-students"]) {
              await endpointHandlers["admin-students"]();
            } else if (!isStudent && endpointHandlers["admin-teachers"]) {
              await endpointHandlers["admin-teachers"]();
            }
          } catch (err) {
            showAlert("loginAlert", err.message || String(err));
          } finally {
            btn.disabled = false;
          }
        });
      })();

      // --- Admin Edit Modals ---
      function ensureAdminEditModal() {
        let el = document.getElementById("adminEditModal");
        if (el) return el;
        const html = `
        <div class="modal fade" id="adminEditModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="adminEditTitle">Edit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div id="adminEditAlert"></div>
                <form id="adminEditForm"></form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="adminEditForm" class="btn btn-primary">Save Changes</button>
              </div>
            </div>
          </div>
        </div>`;
        const container = document.createElement("div");
        container.innerHTML = html;
        document.body.appendChild(container.firstElementChild);
        return document.getElementById("adminEditModal");
      }

      async function openEditStudentModal(studentId) {
        const modalEl = ensureAdminEditModal();
        document.getElementById("adminEditTitle").textContent = "Edit Student";
        const form = document.getElementById("adminEditForm");
        const alertDiv = document.getElementById("adminEditAlert");
        alertDiv.innerHTML = "";
        form.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>`;
        const m = new bootstrap.Modal(modalEl);
        m.show();
        try {
          const full = await apiRequest(
            `/students/${encodeURIComponent(studentId)}/full`
          );
          const student = full.student || {};
          const user = full.user || {};
          form.innerHTML = `
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">First Name</label><input name="first_name" class="form-control" value="${
                student.first_name || ""
              }" required></div>
              <div class="col-md-6"><label class="form-label">Last Name</label><input name="last_name" class="form-control" value="${
                student.last_name || ""
              }" required></div>
              <div class="col-md-6"><label class="form-label">DOB</label><input name="dob" type="date" class="form-control" value="${(
                student.dob || ""
              )
                .toString()
                .slice(0, 10)}"></div>
              <div class="col-md-6"><label class="form-label">Gender</label><input name="gender" class="form-control" value="${
                student.gender || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Admission No</label><input name="admission_no" class="form-control" value="${
                student.admission_no || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Class</label><input name="class_id" class="form-control" value="${
                student.class_id || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Phone</label><input name="phone" class="form-control" value="${
                user.phone || ""
              }"></div>
            </div>`;
          form.onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const payload = {};
            for (const [k, v] of fd.entries())
              if (String(v).trim() !== "") payload[k] = v;
            try {
              await apiRequest(`/students/${encodeURIComponent(studentId)}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              alertDiv.innerHTML =
                '<div class="alert alert-success">Student updated.</div>';
              // adjustCountBadge will trigger an authoritative dashboard refresh
              // Refresh current list if on admin students
              if (endpointHandlers["admin-students"])
                await endpointHandlers["admin-students"]();
              m.hide();
            } catch (err) {
              alertDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
          };
        } catch (e) {
          form.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
        }
      }

      async function openEditTeacherModal(teacherId) {
        const modalEl = ensureAdminEditModal();
        document.getElementById("adminEditTitle").textContent = "Edit Teacher";
        const form = document.getElementById("adminEditForm");
        const alertDiv = document.getElementById("adminEditAlert");
        alertDiv.innerHTML = "";
        form.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>`;
        const m = new bootstrap.Modal(modalEl);
        m.show();
        try {
          const t = await apiRequest(
            `/teachers/${encodeURIComponent(teacherId)}`
          );
          form.innerHTML = `
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">First Name</label><input name="first_name" class="form-control" value="${
                t.first_name || ""
              }" required></div>
              <div class="col-md-6"><label class="form-label">Last Name</label><input name="last_name" class="form-control" value="${
                t.last_name || ""
              }" required></div>
              <div class="col-md-6"><label class="form-label">Date of Birth</label><input name="date_of_birth" type="date" class="form-control" value="${(
                t.date_of_birth || ""
              )
                .toString()
                .slice(0, 10)}"></div>
              <div class="col-md-6"><label class="form-label">Gender</label><input name="gender" class="form-control" value="${
                t.gender || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Employee ID</label><input name="employee_id" class="form-control" value="${
                t.employee_id || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Qualification</label><input name="qualification" class="form-control" value="${
                t.qualification || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Specialization</label><input name="specialization" class="form-control" value="${
                t.specialization || ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Experience Years</label><input name="experience_years" type="number" min="0" class="form-control" value="${
                t.experience_years ?? ""
              }"></div>
              <div class="col-md-6"><label class="form-label">Joining Date</label><input name="joining_date" type="date" class="form-control" value="${(
                t.joining_date || ""
              )
                .toString()
                .slice(0, 10)}"></div>
              <div class="col-md-6"><label class="form-label">Emergency Contact</label><input name="emergency_contact" class="form-control" value="${
                t.emergency_contact || ""
              }"></div>
              <div class="col-12"><label class="form-label">Address</label><textarea name="address" class="form-control" rows="2">${
                t.address || ""
              }</textarea></div>
            </div>`;
          form.onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const payload = {};
            for (const [k, v] of fd.entries())
              if (String(v).trim() !== "") payload[k] = v;
            if (payload.experience_years)
              payload.experience_years = Number(payload.experience_years);
            try {
              await apiRequest(`/teachers/${encodeURIComponent(teacherId)}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              alertDiv.innerHTML =
                '<div class="alert alert-success">Teacher updated.</div>';
              // adjustCountBadge will trigger an authoritative dashboard refresh
              if (endpointHandlers["admin-teachers"])
                await endpointHandlers["admin-teachers"]();
              m.hide();
            } catch (err) {
              alertDiv.innerHTML = `<div class=\"alert alert-danger\">${err.message}</div>`;
            }
          };
        } catch (e) {
          form.innerHTML = `<div class=\"alert alert-danger\">${e.message}</div>`;
        }
      }

      document
        .querySelector(".sidebar-header")
        .addEventListener("click", () => {
          document
            .querySelectorAll(".menu-item")
            .forEach((el) => el.classList.remove("active"));
          document
            .querySelector('[data-endpoint="dashboard"]')
            .classList.add("active");
          loadDashboard();
        });

      showScreen("loginScreen");
    </script>
    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user-circle me-1"></i> My Avatar
            </h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div
              id="profileAvatarWrapper"
              class="d-flex justify-content-center mb-3"
            ></div>
            <div class="mb-3">
              <label class="form-label">Upload New Photo</label>
              <input
                id="avatarFileInput"
                type="file"
                accept="image/*"
                class="form-control"
              />
              <div class="form-text">PNG/JPG up to ~2MB recommended.</div>
            </div>
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-primary"
                onclick="uploadAvatar()"
              >
                <i class="fas fa-upload"></i> Upload
              </button>
              <button
                type="button"
                class="btn btn-outline-danger"
                onclick="removeAvatar()"
              >
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
            <div id="avatarStatus" class="small mt-2 text-muted"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/fair-educare/js/ui.js"></script>
  </body>
</html>
